---
title: "A comprehensive multi-level analysis of the Bucharest Early Intervention Project: Causal effects on recovery from severe deprivation"
date: "2022"
output: 
  github_document:
    toc: true
    toc_depth: 2
---



```{r setup}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Set up environment
```{r}
#Libraries
library(lme4)
library(lmerTest)
library(tidyverse)
library(sjstats)
library(labelled)
library(ggResidpanel)
library(effectsize)
library(ggsci)
library(gt)
library(ggpubr)
library(parameters)
library(cowplot)
library(dplyr)
library(readr)
library(corrr)
library(glue)

source("R_rainclouds.R")

#Files__________________________________________________________________________
home <- "~/Desktop/Tulane/BEIP/comprehensive_analysis/"

cleaned_data_file <- paste0(home, "data/BEIP_big_analysis_tidied_data_20221013.csv")

#Aesthetics_____________________________________________________________________
theme_beip <-
  theme_pubr() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18, hjust = .5),
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 18),
    legend.title = element_text(size = 20), 
    legend.text = element_text(size = 20),
    strip.text = element_text(size = 16),
    legend.position = "bottom"
  )

#Other__________________________________________________________________________
options(scipen = 999) # turn off scientific notation 
set.seed(123456)
cbbPalette <- c(
  "#000000", 
  "#E69F00", 
  "#56B4E9", 
  "#009E73", 
  "#F0E442", 
  "#0072B2", 
  "#D55E00", 
  "#CC79A7"
)
```

# Read in data
```{r}
d  <-
  read_csv(cleaned_data_file) %>% 
  filter(group != "NIG") %>% 
  mutate(
    male = as.factor(male),
    informant = as.factor(informant),
    ethnic = factor(
      ethnic,
      levels = c(0, 1, 2, 3),
      labels = c("Romanian", "Rroma", "Unknown", "Other")
    ),
    wave_ordered = fct_relevel(
      wave,
      "30m", "42m", "54m", "8y", "12y", "16-18y"
    ),
    stable = as.factor(stable)
  ) %>% 
  group_by(ID) %>% 
  mutate(
    stability_group = as.factor(
      case_when(
        group == "FCG" & min(stable_num) == 0 ~ "FCG, Disrupted",
        group == "FCG" & min(stable_num) == 1 ~ "FCG, Stable",
        group == "CAUG" ~ "CAUG"
      )
    )
  ) %>% 
  ungroup()
```

# Descriptives

## Supplemental Tables

### Baseline characteristics
```{r}
d_baseline_physical <-
  d %>%
  filter(wave == "BL", construct == "physical") %>% 
  distinct(ID, value, .keep_all = TRUE) %>% 
  pivot_wider(
    id_cols = c(ID, group),
    names_from = domain,
    values_from = value
  )

d_baseline_physical %>% 
  group_by(group) %>% 
  summarise(
    mean_height = mean(height, na.rm = TRUE),
    sd_height =  sd(height, na.rm = TRUE),
    mean_weight = mean(weight, na.rm = TRUE),
    sd_weight =  sd(weight, na.rm = TRUE)
  )

t.test(d_baseline_physical$height ~ d_baseline_physical$group)
t.test(d_baseline_physical$weight ~ d_baseline_physical$group)
``` 

```{r}
d_baseline <-
  d %>%  
  filter(wave == "BL") %>% 
  distinct(ID, group, .keep_all = TRUE) %>% 
  mutate(
    romanian = ethnic == "Romanian"
  )

d_baseline %>% 
  group_by(group) %>% 
  summarise(
    mean_BW = mean(birth_weight, na.rm = TRUE),
    sd_BQ = sd(birth_weight,  na.rm = TRUE),
    mean_gest_age = mean(gestation_weeks, na.rm = TRUE),
    sd_gest_age = sd(gestation_weeks, na.rm = TRUE),
    mean_pct_inst = mean(pctinst, na.rm = TRUE),
    sd_pct_inst = sd(pctinst, na.rm = TRUE),
    min_pct_inst = min(pctinst, na.rm = TRUE),
    max_pct_inst = max(pctinst, na.rm = TRUE),
    mean_inst_age = mean(inst_entry_age, na.rm = TRUE),
    sd_ints_age = sd(inst_entry_age, na.rm = TRUE),
    mean_bl_age = mean(age_months, na.rm = TRUE),
    sd_bl_age = sd(age_months, na.rm = TRUE),
    min_bl_age = min(age_months, na.rm = TRUE),
    max_bl_age = max(age_months, na.rm = TRUE)
  )


t.test(d_baseline$age_months ~ d_baseline$group)
t.test(d_baseline$birth_weight ~ d_baseline$group)
t.test(d_baseline$gestation_weeks ~ d_baseline$group)
t.test(d_baseline$pctinst ~ d_baseline$group)

d_baseline %>% 
  count(group, male) %>% 
  group_by(group) %>% 
  mutate(per = n / sum(n))

d_baseline %>% 
  count(group, ethnic) %>% 
  group_by(group) %>% 
  mutate(per = n / sum(n))

table_sex <- table(d_baseline$male, d_baseline$group)
prop.test(table_sex)

table_ethnic <- table(d_baseline$romanian, d_baseline$group)
prop.test(table_ethnic)
```
```{r}
d_baseline %>% 
  summarise(
    mean_age_bl = mean(age_months),
    max_age_bl = max(age_months),
    min_age_bl = min(age_months)
  )
```

```{r}
# baseline: length of stay in institutional care (in months)
d_baseline <-
  d_baseline %>% 
  mutate(
    length_inst = age_months - inst_entry_age
  ) 

d_baseline %>% 
  group_by(group) %>% 
  summarise(
    mean_length_inst = mean(length_inst),
    min_length_inst = min(length_inst),
    max_length_inst = max(length_inst)
  )
```

### Remove baseline data 
```{r}
#keep copy with it
d_withBL <-
  d
```

```{r}
#overwrite "d" without it
d <-
  d %>% 
  filter(wave != "BL") %>% 
  ungroup()
```

### Export included ID list 
```{r}
IDs <-
  d %>% 
  filter(!is.na(value)) %>% 
  distinct(ID, group)

IDs_vector <-
  IDs %>% 
  pull(ID)

#write_csv(IDs, paste0(home, "data/included_IDs_20220215.csv"))
```

## Supplemental Analyses: Missingness

### Descriptives: Missingness out of all possible observations

```{r}
d %>% 
  select(
    ID,
    n_obs,
    per_missing
  ) %>% 
  distinct(ID, n_obs, per_missing)  %>% 
  summarise_at(
    vars(n_obs, per_missing),
    funs(mean, median, min, max)
  )

```
  
### Associations of baseline characteristics with missigness

```{r}
d_BL_wide <-
  d_withBL %>%  
  filter(ID %in% IDs_vector) %>% 
  filter(wave == "BL") %>% 
  select(
    ID, 
    group, 
    per_missing,
    domain, 
    value
  ) %>% 
  pivot_wider(
    names_from = domain,
    values_from = value
  ) %>% 
  mutate(
    group = as.factor(group)
  )

```

```{r}
t.test( d_BL_wide$per_missing ~ d_BL_wide$group)
```

```{r}
# regressions with simple effects for CAUG
contrasts(d_BL_wide$group) = c(0, 1)

# DSED
dsed_miss_lm <-
  lm(
    per_missing ~
      group * dsed,
    data = d_BL_wide
  )
summary(dsed_miss_lm)

# RAD
rad_miss_lm <-
  lm(
    per_missing ~
      group * rad,
    data = d_BL_wide
  )
summary(rad_miss_lm)

# ADHD
adhd_miss_lm <-
  lm(
    per_missing ~
      group * adhd,
    data = d_BL_wide
  )
summary(adhd_miss_lm)

# externalizing
extern_miss_lm <-
  lm(
    per_missing ~
      group * extern,
    data = d_BL_wide
  )
summary(extern_miss_lm)

# internalizing 
intern_miss_lm <-
  lm(
    per_missing ~
      group * intern,
    data = d_BL_wide
  )
summary(intern_miss_lm)

# head circumference
head_miss_lm <-
  lm(
    per_missing ~
      group * head,
    data = d_BL_wide
  )
summary(head_miss_lm)

# height
height_miss_lm <-
  lm(
    per_missing ~
      group * height,
    data = d_BL_wide
  )
summary(height_miss_lm)

# weight
weight_miss_lm <-
  lm(
    per_missing ~
      group * weight,
    data = d_BL_wide
  )
summary(weight_miss_lm)

# IQ

iq_miss_lm <-
  lm(
    per_missing ~
      group * iq,
    data = d_BL_wide
  )
summary(iq_miss_lm)
```

```{r}
# regressions with simple effects for FCG
contrasts(d_BL_wide$group) = c(1, 0)

# DSED
dsed_miss_lm.1 <-
  lm(
    per_missing ~
      group * dsed,
    data = d_BL_wide
  )
summary(dsed_miss_lm.1)

# RAD
rad_miss_lm.1 <-
  lm(
    per_missing ~
      group * rad,
    data = d_BL_wide
  )
summary(rad_miss_lm.1)

# ADHD
adhd_miss_lm.1 <-
  lm(
    per_missing ~
      group * adhd,
    data = d_BL_wide
  )
summary(adhd_miss_lm.1)

# externalizing
extern_miss_lm.1 <-
  lm(
    per_missing ~
      group * extern,
    data = d_BL_wide
  )
summary(extern_miss_lm.1)

# internalizing 
intern_miss_lm.1 <-
  lm(
    per_missing ~
      group * intern,
    data = d_BL_wide
  )
summary(intern_miss_lm.1)

# head circumference
head_miss_lm.1 <-
  lm(
    per_missing ~
      group * head,
    data = d_BL_wide
  )
summary(head_miss_lm.1)

# height
height_miss_lm.1 <-
  lm(
    per_missing ~
      group * height,
    data = d_BL_wide
  )
summary(height_miss_lm.1)

# weight
weight_miss_lm.1 <-
  lm(
    per_missing ~
      group * weight,
    data = d_BL_wide
  )
summary(weight_miss_lm.1)

# IQ
iq_miss_lm.1 <-
  lm(
    per_missing ~
      group * iq,
    data = d_BL_wide
  )
summary(iq_miss_lm.1)
```

## CONSORT diagram

```{r}
ids_by_wave <-
  d_baseline %>% 
  select(ID, group) %>% 
  mutate(wBL = 1) %>% 
  left_join(
    d %>% 
      filter(!is.na(value), wave_ordered == "30m") %>% 
      distinct(ID) %>% 
      mutate(w30 = 1),
    by = "ID"
  ) %>% 
  left_join(
    d %>% 
      filter(!is.na(value), wave_ordered == "42m") %>% 
      distinct(ID) %>% 
      mutate(w42 = 1),
    by = "ID"
  ) %>% 
  left_join(
    d %>% 
      filter(!is.na(value), wave_ordered == "54m") %>% 
      distinct(ID) %>% 
      mutate(w54 = 1),
    by = "ID"
  ) %>% 
  left_join(
    d %>% 
      filter(!is.na(value), wave_ordered == "8y") %>% 
      distinct(ID) %>% 
      mutate(w8y = 1),
    by = "ID"
  ) %>% 
  left_join(
    d %>% 
      filter(!is.na(value), wave_ordered == "12y") %>% 
      distinct(ID) %>% 
      mutate(w12y = 1),
    by = "ID"
  ) %>% 
  left_join(
    d %>% 
      filter(!is.na(value), wave_ordered == "16-18y") %>% 
      distinct(ID) %>% 
      mutate(w16_18 = 1),
    by = "ID"
  )

write_csv(ids_by_wave, paste0(home, "data/ids_by_wave_20220217.csv"))
```

### Number of individuals who completed at least one follow-up assessment
```{r}
IDs %>% 
  count(group)
```

### Total number of observations
```{r}
d %>% 
  filter(!is.na(value)) %>% 
  count() 
```
### Total number of observations per group
```{r}
d %>% 
  filter(!is.na(value)) %>% 
  count(group) 
```

### Total number of observations per wave
```{r}
d %>% 
  filter(!is.na(value)) %>% 
  count(wave_ordered) 
```

### Number of individuals per group per wave
```{r}
d %>% 
  filter(!is.na(value)) %>% 
  distinct(ID, group, wave_ordered) %>% 
  count(group, wave_ordered)
```


### Number of observations per group per wave
```{r}
d %>% 
  filter(!is.na(value)) %>% 
  count(group, wave_ordered) %>% 
  arrange(group, wave_ordered)
```

### Number of individuals per group per construct per wave
```{r}
d %>% 
  filter(!is.na(value)) %>% 
  distinct(ID, group, wave_ordered, construct) %>% 
  count(group, wave_ordered, construct) %>% 
  arrange(group, wave_ordered, construct)
```

### Number who completed across waves 
```{r}
d %>% 
  distinct(ID, wave) %>% 
  count(ID, wave) %>% 
  pivot_wider(
    names_from = wave,
    values_from = n,
    names_prefix = "w"
  ) %>% 
  count(!is.na(w30m), !is.na(w42m), !is.na(w54m), !is.na(w8y), !is.na(w12y), !is.na(`w16-18y`)) 
```

# Remove cases with missing data for "value" from dataset 
```{r}
d <-
  d %>% 
  filter(!is.na(value))
```


```{r}
d %>% 
  count(male)
```

# Create subsetted data frames

## Subset IQ, EEG, and physical growth data 

By standardizing within wave, within-person growth effects are no longer detectable. In other words, we cannot say whether X tends to increase as age increases. Instead, we can say that X is relatively higher or lower when age is higher or lower. Because the same measure is being used for multiple types of psychopathology (e.g., ITSEA measures internalizing and externalizing), for psychopathology, must standardize within wave, measure, and domain (i.e., so scores for each domain are relative)

```{r}
d_cog_bio <-
  d %>% 
  filter(construct != "psychopathology") %>% 
  # standardized within wave (eliminates within-person growth effects) and measure (puts all data on same scale)
  group_by(wave, measure, domain) %>% 
  mutate(
    value_z = scale(value)
  ) %>% 
  ungroup() %>% 
  filter() %>% 
  mutate_at(
    vars(domain, informant, group, wave, construct),
    as.factor
  ) %>%
  mutate(
    domain = droplevels(domain),
    informant = droplevels(informant),
    wave = droplevels(wave),
    wave_ordered = droplevels(wave_ordered),
    construct = droplevels(construct)
  )

# number of observations
d_cog_bio %>% 
  count(!is.na(value))

d_cog_bio %>% 
  count(group, !is.na(value))
```

## Subset psychopathology data
```{r}
d_psy <-
  d %>% 
  filter(construct == "psychopathology") %>% 
  group_by(wave, measure, domain) %>%  
  mutate(
    value_z = scale(value)
  ) %>% 
  ungroup() %>% 
  dplyr::select(-construct) %>% 
  mutate_at(
    vars(domain, informant, group, wave),
    as.factor
  ) %>%
  mutate(
    domain = droplevels(domain),
    informant = droplevels(informant),
    wave = droplevels(wave),
    wave_ordered = droplevels(wave_ordered)
  )

# number of observations
d_psy %>% 
  count(!is.na(value))

d_psy %>% 
  count(group, !is.na(value))
```
## Subset FCG data
```{r}
d_fcg_cog_bio <-
  d_cog_bio %>% 
  filter(group == "FCG") 

d_fcg_psy <-
  d_psy %>% 
  filter(group == "FCG")
```

### Stability of FC placement
IDs 82 and 98 reintegrated in bio families prior to FC placement; therefore, not included in stability analyses.
```{r}
d %>% 
  filter(group == "FCG") %>% 
  distinct(ID, stability_group) %>% 
  count(stability_group)

d %>% 
  filter(group == "FCG") %>% 
  distinct(ID, wave_ordered, stable) %>% 
  count(wave_ordered, stable)
```

# Distributions 

## Age
```{r}
d %>% 
  distinct(ID, mean_age_years_wave, wave_ordered) %>% 
  ggplot(aes(mean_age_years_wave, fill = wave_ordered)) +
  geom_histogram(alpha = 1/2) +
  scale_x_continuous(breaks = seq.int(0, 18, 2)) +
  scale_y_continuous(breaks = seq.int(0, 150, 20)) +
  scale_fill_manual(values = cbbPalette) +
  theme_beip +
  theme(
    legend.position = "right"
  ) +
  labs(x = "Age (years)", fill = "Wave")


ggsave(
  paste0(home, "figures/age_years_wave_histogram.png"),
  width = 8, 
  height = 6
)
```

## IQ

```{r}
d_cog_bio %>% 
  filter(construct == "IQ") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 20) +
  #scale_y_continuous(breaks = seq.int(0, 25), 10) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Raw IQ score"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/IQ_histograms.png"),
  dpi = 600,
  width = 7,
  height = 10
)
```

## EEG 

```{r}
d_cog_bio %>% 
  filter(construct == "EEG", str_detect(measure, "relalpha") == TRUE) %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = .05) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "EEG relative alpha power"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/EEG_rel_alpha_histograms.png"),
  dpi = 600,
  width = 7,
  height = 10
)
```

## Physical size 

```{r}
d_cog_bio %>% 
  filter(construct == "physical", domain == "height") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 10) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Height"
  ) +
  facet_grid(wave_ordered~group, scales = "free")

ggsave(
  paste0(home, "figures/height_histograms.png"),
  dpi = 600,
  width = 7,
  height = 10
)
```

```{r}
d_cog_bio %>% 
  filter(construct == "physical", domain == "weight") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 10) +
  scale_x_continuous(breaks = seq.int(0, 110, 20)) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Weight"
  ) +
  facet_grid(wave_ordered~group, scales = "free")

ggsave(
  paste0(home, "figures/weight_histograms.png"),
  dpi = 600,
  width = 7,
  height = 10
)
```

```{r}
d_cog_bio %>% 
  filter(construct == "physical", domain == "head") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 2) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Head circumference"
  ) +
  facet_grid(wave_ordered~group, scales = "free")

ggsave(
  paste0(home, "figures/headcir_histograms.png"),
  dpi = 600,
  width = 7,
  height = 10
)
```
## ADHD
```{r}
d_psy %>% 
  filter(domain == "adhd", measure == "itsea") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = .5) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "ADHD symptoms\n(assessed with ITSEA)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/adhd_histograms_itsea.png"),
  dpi = 600,
  width = 7,
  height = 4.3
)
```

```{r}
d_psy %>% 
  filter(domain == "adhd", measure == "papa") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 5) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "ADHD symptoms\n(assessed with PAPA)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/adhd_histograms_papa.png"),
  dpi = 600,
  width = 7,
  height = 3
)
```
```{r}
d_psy %>% 
  filter(domain == "adhd", measure == "hbq") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = .5) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "ADHD symptoms\n(assessed with HBQ)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/adhd_histograms_hbq.png"),
  dpi = 600,
  width = 7,
  height = 6.3
)
```
```{r}
d_psy %>% 
  filter(domain == "adhd", measure == "disc") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 2) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "ADHD symptoms\n(assessed with DISC)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/adhd_histograms_disc.png"),
  dpi = 600,
  width = 7,
  height = 4.3
)
```
## Internalizing
```{r}
d_psy %>% 
  filter(domain == "intern", measure == "itsea") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = .5) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Internalizing symptoms\n(assessed with ITSEA)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/intern_histograms_itsea.png"),
  dpi = 600,
  width = 7,
  height = 4.3
)
```
```{r}
d_psy %>% 
  filter(domain == "intern", measure == "papa") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 5) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Internalizing symptoms\n(assessed with PAPA)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/intern_histograms_papa.png"),
  dpi = 600,
  width = 7,
  height = 3
)
```

```{r}
d_psy %>% 
  filter(domain == "intern", measure == "hbq") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = .5) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Internalizing symptoms\n(assessed with HBQ)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/intern_histograms_hbq.png"),
  dpi = 600,
  width = 7,
  height = 6.3
)
```

```{r}
d_psy %>% 
  filter(domain == "intern", measure == "disc") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 2) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Internalizing symptoms\n(assessed with DISC)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/intern_histograms_disc.png"),
  dpi = 600,
  width = 7,
  height = 4.3
)
```
## Externalizing
```{r}
d_psy %>% 
  filter(domain == "extern", measure == "itsea") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = .5) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Externalizing symptoms\n(assessed with ITSEA)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/extern_histograms_itsea.png"),
  dpi = 600,
  width = 7,
  height = 4.3
)
```

```{r}
d_psy %>% 
  filter(domain == "extern", measure == "papa") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 5) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Externalizing symptoms\n(assessed with PAPA)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/extern_histograms_papa.png"),
  dpi = 600,
  width = 7,
  height = 3
)
```

```{r}
d_psy %>% 
  filter(domain == "extern", measure == "hbq") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = .5) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Externalizing symptoms\n(assessed with HBQ)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/extern_histograms_hbq.png"),
  dpi = 600,
  width = 7,
  height = 6.3
)
```

```{r}
d_psy %>% 
  filter(domain == "extern", measure == "disc") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 2) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Externalizing symptoms\n(assessed with DISC)"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/extern_histograms_disc.png"),
  dpi = 600,
  width = 7,
  height = 4.3
)
```
## DSED
```{r}
d_psy %>% 
  filter(domain == "dsed") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 2) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Disinhibited social engagement disorder symptoms"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/DSED_histograms.png"),
  dpi = 600,
  width = 7,
  height = 10
)
```

## RAD
```{r}
d_psy %>% 
  filter(domain == "rad") %>% 
  ggplot(aes(value)) +
  geom_histogram(binwidth = 2) +
  theme_beip +
  scale_fill_manual(values = cbbPalette) +
  labs(
    fill = NULL,
    x = "Reactive attachment disorder symptoms"
  ) +
  facet_grid(wave_ordered~group)

ggsave(
  paste0(home, "figures/rad_histograms.png"),
  dpi = 600,
  width = 7,
  height = 10
)
```
## Age of placement in foster care
```{r}
d %>% 
  filter(group == "FCG") %>% 
  distinct(ID, FC_placement_age) %>% 
  ggplot(aes(FC_placement_age)) +
  geom_histogram() +
  scale_y_continuous(breaks = seq.int(0, 10, 1)) +
  theme_beip +
  labs(
    fill = NULL,
    x = "Age of placement in foster care\n(months)"
  )

ggsave(
  paste0(home, "figures/age_placement_histogram.png"),
  width = 9, 
  height = 7
)
```
## Stability of foster care placement
```{r}
d %>% 
  mutate(
    stable = recode_factor(
      stable,
      "disrupted" = "Disrupted",
      "stable" = "Stable"
    )
  ) %>% 
  filter(group == "FCG", !is.na(stable)) %>% 
  distinct(ID, wave_ordered, stable) %>% 
  count(wave_ordered, stable) %>% 
  ggplot(aes(wave_ordered, n, fill = stable)) +
  geom_col(position = "dodge") +
  scale_fill_viridis_d(begin = .5) +
  scale_y_continuous(breaks = seq.int(0, 70, 5)) +
  theme_beip +
  theme(
    legend.position = "right"
  ) +
  labs(
    y = "Number of children",
    x = "Assesment wave",
    fill = "Foster care placement"
  )

ggsave(
  paste0(home, "figures/wave_stability_counts.png"),
  width = 10, 
  height = 6
)
```

# Descriptives: Raw measurement values

## Means, SDs

```{r}
d_baseline %>% 
  filter(group == "FCG") %>% 
  summarise_at(
    vars(FC_placement_age),
    funs(mean, sd, min, max), na.rm = TRUE
  )
```

```{r}
d_cog_bio_summary_iq_phys <- 
  d_cog_bio %>% 
  filter(domain != "eeg") %>% 
  group_by(group, domain) %>% 
  summarise(
    n = n(),
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    se = sd / sqrt(n),
    min = min(value, na.rm = TRUE),
    max = max(value, na.rm = TRUE)
  ) 
d_cog_bio_summary_iq_phys
```

```{r}
d_cog_bio_summary_eeg <- 
  d_cog_bio %>% 
  filter(domain == "eeg") %>% 
  group_by(group, measure) %>% 
  summarise(
    n = n(),
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    se = sd / sqrt(n),
    min = min(value, na.rm = TRUE),
    max = max(value, na.rm = TRUE)
  ) 
d_cog_bio_summary_eeg
```

```{r}
d_psy_summary_overall <- 
  d_psy %>% 
  group_by(group, domain, measure) %>% 
  summarise(
    n = n(),
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    se = sd / sqrt(n),
    min = min(value, na.rm = TRUE),
    max = max(value, na.rm = TRUE)
  )
d_psy_summary_overall
```

```{r}
d_cog_bio_summary <- 
  d_cog_bio %>% 
  group_by(group, wave_ordered, domain) %>% 
  summarise(
    n = n(),
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    se = sd / sqrt(n),
    min = min(value, na.rm = TRUE),
    max = max(value, na.rm = TRUE)
  ) 

d_psy_summary <- 
  d_psy %>% 
  group_by(group, wave_ordered, domain) %>% 
  summarise(
    n = n(),
    mean = mean(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    se = sd / sqrt(n),
    min = min(value, na.rm = TRUE),
    max = max(value, na.rm = TRUE)
  )
```

```{r}
d_cog_bio %>% 
  filter(domain == "eeg") %>% 
  group_by(wave_ordered, group) %>% 
  summarise_at(
    vars(value, value_z),
    funs(mean, sd)
  )
```
# Correlations
```{r}
out_corr <- 
  d_cog_bio %>% 
  filter(domain != "eeg") %>% 
  dplyr::select(ID, domain, value_z) %>% 
  bind_rows(
    d_cog_bio %>% 
      filter(domain == "eeg") %>% 
      mutate(domain = measure) %>% 
      dplyr::select(ID, domain, value_z)
  ) %>% 
  bind_rows(
    d_psy %>% 
      dplyr::select(ID, domain, value_z)
  ) %>% 
  group_by(ID, domain) %>% 
  summarise(value_z = mean(value_z, na.rm = TRUE)) %>% 
  dplyr::select(
    domain,
    value_z
  ) %>% 
  spread(domain, value_z) %>% 
  ungroup() %>% 
  dplyr::select(-ID) %>% 
  corrr::correlate(method = "spearman") %>% 
  fashion() 

out_corr
```

```{r}
out_corr_plot <- 
  out_corr %>% 
  gather(variable, value, -term) %>% 
  mutate(
    term = as.character(term),
    value_chr = as.character(value),
    value_num = as.numeric(value_chr)
  ) %>% 
  na.omit() %>% 
  mutate(
    term = factor(
      term,
      levels = c(
        "iq", 
        "head", 
        "height", 
        "weight",
        "relalpha",
        "dsed",
        "rad",
        "adhd",
        "extern",
        "intern"
      ),
      labels = c(
        "IQ",
        "Head circumference",
        "Height",
        "Weight",
        "EEG alpha power",
        "DSED",
        "RAD",
        "ADHD",
        "Externalizing",
        "Internalizing"
      )
    ),
    variable = factor(
      variable,
      levels = c(
        "iq", 
        "head", 
        "height", 
        "weight",
        "relalpha",
        "dsed",
        "rad",
        "adhd",
        "extern",
        "intern"
      ),
      labels = c(
        "IQ",
        "Head circumference",
        "Height",
        "Weight",
        "EEG alpha power",
        "DSED",
        "RAD",
        "ADHD",
        "Externalizing",
        "Internalizing"
      )
    )
  )
```

```{r}
out_corr_plot %>% 
  ggplot(aes(x = variable, y = fct_rev(term))) +
  geom_tile(aes(fill = abs(value_num))) +
  geom_text(
    aes(label = value_chr), 
    size = 4
  ) +
  scale_fill_gradient2(
    low = "blue",
    high = "red",
    mid = "white",
    na.value = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = "Spearman correlation\ncoefficient"
  ) +
  theme_void() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      vjust = 1,
      size = 12
    ),
    axis.text.y = element_text(
      size = 12,
      hjust = .9
    )
  ) 

ggsave(
  paste0(home, "figures/correlations.png"),
  dpi = 600,
  width = 8, 
  height = 6
)
```
```{r}
d_cog_bio %>% 
  distinct(ID, sibling_type) %>% 
  count(sibling_type)
```

# Results

## Aim 1 

### EEG, IQ, physical size

#### Main effect of group (with main effect covariates)

```{r}
# CAUG is baseline
contrasts(d_cog_bio$group) = c(0, 1)

contrasts(d_cog_bio$male) = c(-.5, .5) 

contrasts(d_cog_bio$construct) <- cbind(
  "IQvEEG" = c(-1/3, 1 - (1/3), -1/3),
  "PHYSvEEG" = c(-1/3, -1/3, 1 - (1/3))
)
```

```{r}
a1_cogbio <- lmer(
  value_z ~ 
    group +
    male +
    scale(age_years, scale = TRUE) +
    construct +
    (1|ID) +
    (1|family_id), 
  data = d_cog_bio
)

set.seed(123456)
a1_cogbio_parameters <-
  model_parameters(
  a1_cogbio,
  bootstrap = TRUE,
  ci_method = "quantile",
  iterations = 1000
)

a1_cogbio_parameters
```


```{r}
# supplementary analysis with extended random effects structure
a1_cogbio_rex <- lmer(
  value_z ~ 
    group +
    male +
    scale(age_years, scale = TRUE) +
    construct +
    (1|ID) +
    (1|ID:construct) +
    (1|family_id), 
  data = d_cog_bio
)

set.seed(123456)
a1_cogbio_parameters_rex <-
  model_parameters(
  a1_cogbio_rex,
  bootstrap = TRUE,
  ci_method = "quantile",
  iterations = 1000
)

a1_cogbio_parameters_rex
```


```{r}
forest_df <-
  tibble(
    Parameter = "Overall cognitive, physical, and neural",
    Coefficient = a1_cogbio_parameters$Coefficient[[2]],
    CI_low = a1_cogbio_parameters$CI_low[[2]],
    CI_high = a1_cogbio_parameters$CI_high[[2]],
    p = a1_cogbio_parameters$p[[2]],
  )
```

### Psychopathology

#### Main effect of group (with main effect covariates)

```{r}
# contrast code to center all variables except group; allows interpretation of coefficient as averages across levels of other factors
contrasts(d_psy$group) = c(0, 1) # CAUG is baseline

contrasts(d_psy$male) = c(-.5, .5) 

contrasts(d_psy$domain) = cbind(
  DSEDvADHD = c(-1/5, 1 - (1/5), -1/5, -1/5, -1/5),
  EXTvADHD = c(-1/5, -1/5, 1 - (1/5), -1/5, -1/5),
  INTvADHD = c(-1/5, -1/5, -1/5, 1 - (1/5), -1/5),
  RADvADHD = c(-1/5, -1/5, -1/5, -1/5, 1 - (1/5))
)

contrasts(d_psy$informant) = c(-.5, .5)
```


```{r}
a1_psy <- lmer(
  value_z ~ 
    group +
    male +
    scale(age_years, scale = TRUE) +
    domain +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_psy
)

set.seed(123456)
a1_psy_parameters <-
  model_parameters(
    a1_psy,
    bootstrap = TRUE,
    ci_method = "quantile",
    effects = "fixed",
    iterations = 1000
  )

a1_psy_parameters
```

```{r}
# supplementary analysis with extended random effects structure
a1_psy_rex <- lmer(
  value_z ~ 
    group +
    male +
    scale(age_years, scale = TRUE) +
    domain +
    informant +
    (1|ID) +
    (1|ID:domain) +
    (1|family_id), 
  data = d_psy
)

set.seed(123456)
a1_psy_parameters_rex <-
  model_parameters(
    a1_psy_rex,
    bootstrap = TRUE,
    ci_method = "quantile",
    effects = "fixed",
    iterations = 1000
  )

a1_psy_parameters_rex
```

```{r}
forest_df <-
  forest_df %>% 
  rbind( 
    c(
      "Overall psychopathology",
      a1_psy_parameters$Coefficient[[2]],
      a1_psy_parameters$CI_low[[2]],
      a1_psy_parameters$CI_hi[[2]],
      a1_psy_parameters$p[[2]]
    )
  )
  
```

## Aim 2

### EEG, IQ, physical size

#### Two-way moderations
```{r}
a2_cogbio <- lmer(
  value_z ~ 
    group * construct +
    group * male +
    group * scale(age_years, scale = FALSE) +
    (1|ID) +
    (1|family_id), 
  REML = FALSE,
  data = d_cog_bio
)

set.seed(123456)
a2_cogbio_parameters <-
  model_parameters(
    a2_cogbio,
    bootstrap = TRUE,
    ci_method = "quantile",
    effects = "fixed",
    iterations = 1000
  )

anova(a2_cogbio)
```

##### Simple effects of outcome domain (IQ vs. EEG vs. physical size )

###### EEG
```{r}
# EEG = baseline
contrasts(d_cog_bio$construct) <- cbind(
  "IQvEEG" = c(0, 1, 0),
  "PHYSvEEG" = c(0, 0, 1)
)

# CAUG = baseline
a2_cogbio_EEG <- lmer(
  value_z ~ 
    group * construct +
    male +
    scale(age_years, scale = TRUE) +
    (1|ID) +
    (1|family_id), 
  data = d_cog_bio
)

set.seed(123456)
a2_cogbio_EEG_parameters <-
  model_parameters(
    a2_cogbio_EEG,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a2_cogbio_EEG_parameters
```

```{r}
forest_df <-
  forest_df %>% 
  rbind( 
    c(
      "EEG alpha power",
      a2_cogbio_EEG_parameters$Coefficient[[2]],
      a2_cogbio_EEG_parameters$CI_low[[2]],
      a2_cogbio_EEG_parameters$CI_hi[[2]],
      a2_cogbio_EEG_parameters$p[[2]]
    )
  )
```

###### IQ
```{r}
# IQ = baseline
contrasts(d_cog_bio$construct) <- cbind(
  "EEGvIQ" = c(1, 0, 0),
  "PHYSvIQ" = c(0, 0, 1)
)

a2_cogbio_IQ <- lmer(
  value_z ~ 
    group * construct +
    male +
    scale(age_years, scale = TRUE) +
    (1|ID) +
    (1|family_id),  
  data = d_cog_bio
)

set.seed(123456)
a2_cogbio_IQ_parameters <-
  model_parameters(
    a2_cogbio_IQ,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_cogbio_IQ_parameters
```

```{r}
forest_df <-
  forest_df %>% 
  rbind( 
    c(
      "IQ",
      a2_cogbio_IQ_parameters$Coefficient[[2]],
      a2_cogbio_IQ_parameters$CI_low[[2]],
      a2_cogbio_IQ_parameters$CI_hi[[2]],
      a2_cogbio_IQ_parameters$p[[2]]
    )
  )
```

###### Physical size 
```{r}
# PHYS = baseline
contrasts(d_cog_bio$construct) <- cbind(
  "EEGvPHYS" = c(1, 0, 0),
  "IQvPHYS" = c(0, 1, 0)
)

a2_cogbio_PHY <- lmer(
  value_z ~ 
    group * construct +
    male +
    scale(age_years, scale = TRUE) +
    (1|ID) +
    (1|family_id),  
  data = d_cog_bio
)

set.seed(123456)
a2_cogbio_PHY_parameters <- 
  model_parameters(
    a2_cogbio_PHY,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_cogbio_PHY_parameters
```

```{r}
forest_df <-
  forest_df %>% 
  rbind( 
    c(
      "Physical growth",
      a2_cogbio_PHY_parameters$Coefficient[[2]],
      a2_cogbio_PHY_parameters$CI_low[[2]],
      a2_cogbio_PHY_parameters$CI_hi[[2]],
      a2_cogbio_PHY_parameters$p[[2]]
    )
  )
```

#### Three-way moderations
```{r}
a2_cogbio_domainXage <- lmer(
  value_z ~ 
    group * construct * scale(age_years, scale = FALSE) +
    male +
    (1|ID) +
    (1|family_id),  
  data = d_cog_bio
)

anova(a2_cogbio_domainXage)
```

```{r}
a2_cogbio_domainXsex <- lmer(
  value_z ~ 
    group * construct * male +
    scale(age_years, scale = TRUE) +
    (1|ID) +
    (1|family_id),  
  data = d_cog_bio
)

anova(a2_cogbio_domainXsex)
```

##### Simple effects of sex and outcome domain

###### Male, EEG
```{r}
# EEG = baseline
contrasts(d_cog_bio$construct) <- cbind(
  "IQvEEG" = c(0, 1, 0),
  "PHYSvEEG" = c(0, 0, 1)
)

# Male = baseline
contrasts(d_cog_bio$male) = c(1, 0)

a2_cogbio_EEG_male <- lmer(
  value_z ~ 
    group * construct * male +
    scale(age_years, scale = TRUE) +
    (1|ID) +
    (1|family_id),  
  data = d_cog_bio
)

set.seed(123456)
a2_cogbio_EEG_male_parameters <-
  model_parameters(
    a2_cogbio_EEG_male,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_cogbio_EEG_male_parameters
```

###### Female, EEG
```{r}
# EEG = baseline
contrasts(d_cog_bio$construct) <- cbind(
  "IQvEEG" = c(0, 1, 0),
  "PHYSvEEG" = c(0, 0, 1)
)

# Female = baseline
contrasts(d_cog_bio$male) = c(0, 1)

a2_cogbio_EEG_female <- lmer(
  value_z ~ 
    group * construct * male +
    scale(age_years, scale = TRUE) +
    (1|ID) +
    (1|family_id),  
  data = d_cog_bio
)

set.seed(123456)
a2_cogbio_EEG_female_parameters <-
  model_parameters(
    a2_cogbio_EEG_female,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_cogbio_EEG_female_parameters
```

###### Male, IQ
```{r}
# IQ = baseline
contrasts(d_cog_bio$construct) <- cbind(
  "EEGvIQ" = c(1, 0, 0),
  "PHYSvIQ" = c(0, 0, 1)
)

# Male = baseline
contrasts(d_cog_bio$male) = c(1, 0)

a2_cogbio_IQ_male <- lmer(
  value_z ~ 
    group * construct * male +
    scale(age_years, scale = TRUE) +
    (1|ID) +
    (1|family_id), 
  data = d_cog_bio
)

set.seed(123456)
a2_cogbio_IQ_male_parameters <-
  model_parameters(
    a2_cogbio_IQ_male,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_cogbio_IQ_male_parameters
```

###### Female, IQ
```{r}
# IQ = baseline
contrasts(d_cog_bio$construct) <- cbind(
  "EEGvIQ" = c(1, 0, 0),
  "PHYSvIQ" = c(0, 0, 1)
)

# Female = baseline
contrasts(d_cog_bio$male) = c(0, 1)

a2_cogbio_IQ_female <- lmer(
  value_z ~ 
    group * construct * male +
    scale(age_years, scale = TRUE) +
    (1|ID) +
    (1|family_id),  
  data = d_cog_bio
)

set.seed(123456)
a2_cogbio_IQ_female_parameters <-
  model_parameters(
    a2_cogbio_IQ_female,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_cogbio_IQ_female_parameters
```

###### Male, physical size
```{r}
# PHYS = baseline
contrasts(d_cog_bio$construct) <- cbind(
  "EEGvPHYS" = c(1, 0, 0),
  "IQvPHYS" = c(0, 1, 0)
)

# Male = baseline
contrasts(d_cog_bio$male) = c(1, 0)

a2_cogbio_PHYS_male <- lmer(
  value_z ~ 
    group * construct * male +
    scale(age_years, scale = TRUE) +
    (1|ID) +
    (1|family_id), 
  data = d_cog_bio
)

set.seed(123456)
a2_cogbio_PHYS_male_parameters <-
  model_parameters(
    a2_cogbio_PHYS_male,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_cogbio_PHYS_male_parameters
```

###### Female, physical size
```{r}
# PHYS = baseline
contrasts(d_cog_bio$construct) <- cbind(
  "EEGvPHYS" = c(1, 0, 0),
  "IQvPHYS" = c(0, 1, 0)
)

# Female = baseline
contrasts(d_cog_bio$male) = c(0, 1)

a2_cogbio_PHYS_female <- lmer(
  value_z ~ 
    group * construct * male +
    scale(age_years, scale = TRUE) +
    (1|ID) +
    (1|family_id),  
  data = d_cog_bio
)

set.seed(123456)
a2_cogbio_PHYS_female_parameters <-
  model_parameters(
    a2_cogbio_PHYS_female,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_cogbio_PHYS_female_parameters
```

### Psychopathology

#### Two-way moderations
```{r}
a2_psy_type <- lmer(
  value_z ~ 
    group * domain +
    group * male +
    group * scale(age_years, scale = TRUE) +
    informant +
    (1|ID) +
    (1|family_id),  
  data = d_psy
)

anova(a2_psy_type)
```

##### Simple effects of type of psychopathology

###### ADHD
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# ADHD = baseline
contrasts(d_psy$domain) = cbind(
  DSEDvADHD = c(0, 1, 0, 0, 0),
  EXTvADHD = c(0, 0, 1, 0, 0),
  INTvADHD = c(0, 0, 0, 1, 0),
  RADvADHD = c(0, 0, 0, 0, 1)
)

a2_psy_ADHD <- lmer(
  value_z ~ 
    group * domain + 
    male +
    scale(age_years, scale = TRUE) +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_psy
)

set.seed(123456)
a2_psy_ADHD_parameters <- 
  model_parameters(
    a2_psy_ADHD,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_psy_ADHD_parameters
```

```{r}
forest_df <-
  forest_df %>% 
  rbind( 
    c(
      "ADHD",
      a2_psy_ADHD_parameters$Coefficient[[2]],
      a2_psy_ADHD_parameters$CI_low[[2]],
      a2_psy_ADHD_parameters$CI_hi[[2]],
      a2_psy_ADHD_parameters$p[[2]]
    )
  )
```

###### DSED
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# DSED = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvDSED = c(1, 0, 0, 0, 0),
  EXTvDSED = c(0, 0, 1, 0, 0),
  INTvDSED = c(0, 0, 0, 1, 0),
  RADvDSED = c(0, 0, 0, 0, 1)
)

a2_psy_DSED <- lmer(
  value_z ~ 
    group * domain + 
    male +
    scale(age_years, scale = TRUE) +
    informant +
    (1|ID) +
    (1|family_id),  
  data = d_psy
)

set.seed(123456)
a2_psy_DSED_parameters <-
  model_parameters(
    a2_psy_DSED,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a2_psy_DSED_parameters
```

```{r}
forest_df <-
  forest_df %>% 
  rbind( 
    c(
      "Disinhibited social engagement disorder",
      a2_psy_DSED_parameters$Coefficient[[2]],
      a2_psy_DSED_parameters$CI_low[[2]],
      a2_psy_DSED_parameters$CI_hi[[2]],
      a2_psy_DSED_parameters$p[[2]]
    )
  )
```

###### Externalizing
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# EXT = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvEXT = c(1, 0, 0, 0, 0),
  DSEDvEXT = c(0, 1, 0, 0, 0),
  INTvEXT = c(0, 0, 0, 1, 0),
  RADvEXT = c(0, 0, 0, 0, 1)
)

a2_psy_EXT <- lmer(
  value_z ~ 
    group * domain + 
    male +
    scale(age_years, scale = TRUE) +
    informant +
    (1|ID) +
    (1|family_id),  
  data = d_psy
)

set.seed(123456)
a2_psy_EXT_parameters <-
  model_parameters(
    a2_psy_EXT,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_psy_EXT_parameters
```

```{r}
forest_df <-
  forest_df %>% 
  rbind( 
    c(
      "Externalizing",
      a2_psy_EXT_parameters$Coefficient[[2]],
      a2_psy_EXT_parameters$CI_low[[2]],
      a2_psy_EXT_parameters$CI_hi[[2]],
      a2_psy_EXT_parameters$p[[2]]
    )
  )
```

###### Internalizing
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# INT = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvINT = c(1, 0, 0, 0, 0),
  DSEDvINT = c(0, 1, 0, 0, 0),
  INTvEXT = c(0, 0, 1, 0, 0),
  RADvINT = c(0, 0, 0, 0, 1)
)

a2_psy_INT <- lmer(
  value_z ~ 
    group * domain + 
    male +
    scale(age_years, scale = TRUE) +
    informant +
    (1|ID) +
    (1|family_id),  
  data = d_psy
)

set.seed(123456)
a2_psy_INT_parameters <-
  model_parameters(
    a2_psy_INT,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_psy_INT_parameters
```

```{r}
forest_df <-
  forest_df %>% 
  rbind( 
    c(
      "Internalizing",
      a2_psy_INT_parameters$Coefficient[[2]],
      a2_psy_INT_parameters$CI_low[[2]],
      a2_psy_INT_parameters$CI_hi[[2]],
      a2_psy_INT_parameters$p[[2]]
    )
  )
```

###### RAD
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# RAD = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvRAD = c(1, 0, 0, 0, 0),
  DSEDvRAD = c(0, 1, 0, 0, 0),
  EXTvRAD = c(0, 0, 1, 0, 0),
  INTvRAD = c(0, 0, 0, 1, 0)
)

a2_psy_RAD <- lmer(
  value_z ~ 
    group * domain + 
    male +
    scale(age_years, scale = TRUE) +
    informant +
    (1|ID) +
    (1|family_id),   
  data = d_psy
)

set.seed(123456)
a2_psy_RAD_parameters <- 
  model_parameters(
    a2_psy_RAD,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_psy_RAD_parameters
```

```{r}
forest_df <-
  forest_df %>% 
  rbind( 
    c(
      "Reactive attachment disorder",
      a2_psy_RAD_parameters$Coefficient[[2]],
      a2_psy_RAD_parameters$CI_low[[2]],
      a2_psy_RAD_parameters$CI_hi[[2]],
      a2_psy_RAD_parameters$p[[2]]
    )
  )
```

#### Three-way moderations
```{r}
a2_psy_type_gender <- lmer(
  value_z ~ 
    group * domain * male +
    scale(age_years, scale = TRUE) +
    informant +
    (1|ID) +
    (1|family_id),  
  data = d_psy
)

anova(a2_psy_type_gender)
```

```{r}
a2_psy_type_age <- lmer(
  value_z ~ 
    group * domain * scale(age_years, scale = TRUE) +
    male +
    informant +
    (1|ID) +
    (1|family_id),   
  data = d_psy
)

anova(a2_psy_type_age)
```

##### Simple effects of type of psychopathology and age of assessment

###### ADHD, 42 months (3.5 years)
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# ADHD = baseline
contrasts(d_psy$domain) = cbind(
  DSEDvADHD = c(0, 1, 0, 0, 0),
  EXTvADHD = c(0, 0, 1, 0, 0),
  INTvADHD = c(0, 0, 0, 1, 0),
  RADvADHD = c(0, 0, 0, 0, 1)
)

a2_ADHD_age3 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 3.5) +
    male +
    informant +
    (1|ID) +
    (1|family_id),  
  data = d_psy
)

set.seed(123456)
a2_ADHD_age3_parameters <- 
  model_parameters(
    a2_ADHD_age3,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_ADHD_age3_parameters
```

###### ADHD, 8 years 
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# ADHD = baseline
contrasts(d_psy$domain) = cbind(
  DSEDvADHD = c(0, 1, 0, 0, 0),
  EXTvADHD = c(0, 0, 1, 0, 0),
  INTvADHD = c(0, 0, 0, 1, 0),
  RADvADHD = c(0, 0, 0, 0, 1)
)

a2_ADHD_age8 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 8) +
    male +
    informant +
    (1|ID) +
    (1|family_id),  
  data = d_psy
)

set.seed(123456)
a2_ADHD_age8_parameters <- 
  model_parameters(
    a2_ADHD_age8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_ADHD_age8_parameters
```

###### ADHD, 16 years 
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# ADHD = baseline
contrasts(d_psy$domain) = cbind(
  DSEDvADHD = c(0, 1, 0, 0, 0),
  EXTvADHD = c(0, 0, 1, 0, 0),
  INTvADHD = c(0, 0, 0, 1, 0),
  RADvADHD = c(0, 0, 0, 0, 1)
)

a2_ADHD_age16 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 16) +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_psy
)

set.seed(123456)
a2_ADHD_age16_parameters <- 
  model_parameters(
    a2_ADHD_age16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_ADHD_age16_parameters
```

###### DSED, 42 months (3.5 years)
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# DSED = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvDSED = c(1, 0, 0, 0, 0),
  EXTvDSED = c(0, 0, 1, 0, 0),
  INTvDSED = c(0, 0, 0, 1, 0),
  RADvDSED = c(0, 0, 0, 0, 1)
)

a2_DSED_age3 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 3.5) +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_psy
)

set.seed(123456)
a2_DSED_age3_parameters <-
  model_parameters(
    a2_DSED_age3,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a2_DSED_age3_parameters
```

###### DSED, 8 years
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# DSED = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvDSED = c(1, 0, 0, 0, 0),
  EXTvDSED = c(0, 0, 1, 0, 0),
  INTvDSED = c(0, 0, 0, 1, 0),
  RADvDSED = c(0, 0, 0, 0, 1)
)

a2_DSED_age8 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 8) +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_psy
)

set.seed(123456)
a2_DSED_age8_parameters <-
  model_parameters(
    a2_DSED_age8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a2_DSED_age8_parameters
```

###### DSED, 16 years
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# DSED = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvDSED = c(1, 0, 0, 0, 0),
  EXTvDSED = c(0, 0, 1, 0, 0),
  INTvDSED = c(0, 0, 0, 1, 0),
  RADvDSED = c(0, 0, 0, 0, 1)
)

a2_DSED_age16 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 16) +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_psy
)

set.seed(123456)
a2_DSED_age16_parameters <-
  model_parameters(
    a2_DSED_age16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a2_DSED_age16_parameters
```

###### Externalizing, 42 months (3.5 years)
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# EXT = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvEXT = c(1, 0, 0, 0, 0),
  DSEDvEXT = c(0, 1, 0, 0, 0),
  INTvEXT = c(0, 0, 0, 1, 0),
  RADvEXT = c(0, 0, 0, 0, 1)
)

a2_EXT_age3 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 3.5) +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_psy
)

set.seed(123456)
a2_EXT_age3_parameters <-
  model_parameters(
    a2_EXT_age3,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_EXT_age3_parameters
```

###### Externalizing, 8 years
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# EXT = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvEXT = c(1, 0, 0, 0, 0),
  DSEDvEXT = c(0, 1, 0, 0, 0),
  INTvEXT = c(0, 0, 0, 1, 0),
  RADvEXT = c(0, 0, 0, 0, 1)
)

a2_EXT_age8 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 8) +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_psy
)

set.seed(123456)
a2_EXT_age8_parameters <-
  model_parameters(
    a2_EXT_age8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_EXT_age8_parameters
```

###### Externalizing, 16 years
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# EXT = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvEXT = c(1, 0, 0, 0, 0),
  DSEDvEXT = c(0, 1, 0, 0, 0),
  INTvEXT = c(0, 0, 0, 1, 0),
  RADvEXT = c(0, 0, 0, 0, 1)
)

a2_EXT_age16 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 16) +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_psy
)

set.seed(123456)
a2_EXT_age16_parameters <-
  model_parameters(
    a2_EXT_age16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_EXT_age16_parameters
```

###### Internalizing, 42 months (3.5 years)
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# INT = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvINT = c(1, 0, 0, 0, 0),
  DSEDvINT = c(0, 1, 0, 0, 0),
  INTvINT = c(0, 0, 1, 0, 0),
  RADvINT = c(0, 0, 0, 0, 1)
)

a2_INT_age3 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 3.5) +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_psy
)

set.seed(123456)
a2_INT_age3_parameters <-
  model_parameters(
    a2_INT_age3,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_INT_age3_parameters
```

###### Internalizing, 8 years
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# INT = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvINT = c(1, 0, 0, 0, 0),
  DSEDvINT = c(0, 1, 0, 0, 0),
  INTvINT = c(0, 0, 1, 0, 0),
  RADvINT = c(0, 0, 0, 0, 1)
)

a2_INT_age8 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 8) +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_psy
)

set.seed(123456)
a2_INT_age8_parameters <-
  model_parameters(
    a2_INT_age8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_INT_age8_parameters
```

###### Internalizing, 16 years
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# INT = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvINT = c(1, 0, 0, 0, 0),
  DSEDvINT = c(0, 1, 0, 0, 0),
  INTvINT = c(0, 0, 1, 0, 0),
  RADvINT = c(0, 0, 0, 0, 1)
)

a2_INT_age16 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 16) +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_psy
)

set.seed(123456)
a2_INT_age16_parameters <-
  model_parameters(
    a2_INT_age16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_INT_age16_parameters
```

###### RAD, 42 months (3.5 years)
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# RAD = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvRAD = c(1, 0, 0, 0, 0),
  DSEDvRAD = c(0, 1, 0, 0, 0),
  EXTvRAD = c(0, 0, 1, 0, 0),
  INTvRAD = c(0, 0, 0, 1, 0)
)

a2_RAD_age3 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 3.5) +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_psy
)

set.seed(123456)
a2_RAD_age3_parameters <- 
  model_parameters(
    a2_RAD_age3,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_RAD_age3_parameters
```

###### RAD, 8 years
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# RAD = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvRAD = c(1, 0, 0, 0, 0),
  DSEDvRAD = c(0, 1, 0, 0, 0),
  EXTvRAD = c(0, 0, 1, 0, 0),
  INTvRAD = c(0, 0, 0, 1, 0)
)

a2_RAD_age8 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 8) +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_psy
)

set.seed(123456)
a2_RAD_age8_parameters <- 
  model_parameters(
    a2_RAD_age8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_RAD_age8_parameters
```

###### RAD, 16 years
```{r}
# CAUG = baseline
contrasts(d_psy$group) = c(0, 1)

# RAD = baseline
contrasts(d_psy$domain) = cbind(
  ADHDvRAD = c(1, 0, 0, 0, 0),
  DSEDvRAD = c(0, 1, 0, 0, 0),
  EXTvRAD = c(0, 0, 1, 0, 0),
  INTvRAD = c(0, 0, 0, 1, 0)
)

a2_RAD_age16 <- lmer(
  value_z ~ 
    group * domain * I(age_years - 16) +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_psy
)

set.seed(123456)
a2_RAD_age16_parameters <- 
  model_parameters(
    a2_RAD_age16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a2_RAD_age16_parameters
```


## Aim 3

### Age of placement

#### IQ, EEG, physical size

##### Main effect of age of placement

```{r}
contrasts(d_fcg_cog_bio$male) = c(-.5, .5) 

contrasts(d_fcg_cog_bio$construct) <- cbind(
  "IQvEEG" = c(-1/3, 1 - (1/3), -1/3),
  "PHYSvEEG" = c(-1/3, -1/3, 1 - (1/3))
)
```

```{r}
a3_age_placement_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) +
    male +
    scale(age_years, scale = TRUE) +
    construct +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

a3_age_placement_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) +
    male +
    scale(age_years, scale = TRUE) +
    construct +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_age_placement_parameters_std <-
  model_parameters(
    a3_age_placement_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_age_placement_parameters_std

set.seed(123456)
a3_age_placement_parameters_raw <-
  model_parameters(
    a3_age_placement_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_age_placement_parameters_raw
```

```{r}
# supplementary analysis with extended random effects structure
a3_age_placement_std_rex <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) +
    male +
    scale(age_years, scale = TRUE) +
    construct +
    (1|ID) +
    (1|ID:construct) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

a3_age_placement_raw_rex <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) +
    male +
    scale(age_years, scale = TRUE) +
    construct +
    (1|ID) +
    (1|ID:construct) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_age_placement_parameters_std_rex <-
  model_parameters(
    a3_age_placement_std_rex,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_age_placement_parameters_std_rex

set.seed(123456)
a3_age_placement_parameters_raw_rex <-
  model_parameters(
    a3_age_placement_raw_rex,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_age_placement_parameters_raw_rex
```

###### Two-way moderations
```{r}
a3_age_placement_std_X <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * male +
    scale(FC_placement_age, scale = TRUE) * scale(age_years, scale = TRUE) +
    scale(FC_placement_age, scale = TRUE) * construct +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

anova(a3_age_placement_std_X)
```

###### Simple effects of outcome domain (IQ vs. EEG vs. physical size )

###### EEG
```{r}
# EEG = baseline
contrasts(d_fcg_cog_bio$construct) <- cbind(
  "IQvEEG" = c(0, 1, 0),
  "PHYSvEEG" = c(0, 0, 1)
)

a3_age_placement_EEG_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * construct +
    scale(age_years, scale = TRUE) +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

a3_age_placement_EEG_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) * construct +
    scale(age_years, scale = TRUE) +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_age_placement_EEG_parameters_std <- 
  model_parameters(
    a3_age_placement_EEG_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_EEG_parameters_std

set.seed(123456)
a3_age_placement_EEG_parameters_raw <- 
  model_parameters(
    a3_age_placement_EEG_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_EEG_parameters_raw
```

###### IQ
```{r}
# IQ = baseline
contrasts(d_fcg_cog_bio$construct) <- cbind(
  "EEGvIQ" = c(1, 0, 0),
  "PHYSvIQ" = c(0, 0, 1)
)

a3_age_placement_IQ_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * construct +
    scale(age_years, scale = TRUE) +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

a3_age_placement_IQ_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) * construct +
    scale(age_years, scale = TRUE) +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_age_placement_IQ_parameters_std <- 
  model_parameters(
    a3_age_placement_IQ_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_IQ_parameters_std

set.seed(123456)
a3_age_placement_IQ_parameters_raw <- 
  model_parameters(
    a3_age_placement_IQ_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_IQ_parameters_raw
```

###### Physical size 
```{r}
# PHYS = baseline
contrasts(d_fcg_cog_bio$construct) <- cbind(
  "EEGvPHYS" = c(1, 0, 0),
  "IQvPHYS" = c(0, 1, 0)
)

a3_age_placement_PHY_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * construct +
    scale(age_years, scale = TRUE) +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

a3_age_placement_PHY_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) * construct +
    scale(age_years, scale = TRUE) +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_age_placement_PHY_parameters_std <- 
  model_parameters(
    a3_age_placement_PHY_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_PHY_parameters_std

set.seed(123456)
a3_age_placement_PHY_parameters_raw <- 
  model_parameters(
    a3_age_placement_PHY_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_PHY_parameters_raw
```

###### Simple effects of age of asssesment

###### 42 months (3.5 years)
```{r}
contrasts(d_fcg_cog_bio$construct) <- cbind(
  "IQvEEG" = c(-1/3, 1 - (1/3), -1/3),
  "PHYSvEEG" = c(-1/3, -1/3, 1 - (1/3))
)

a3_age_placement_age3_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * I(age_years - 3.5) +
    construct +
    male +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

a3_age_placement_age3_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) * I(age_years - 3.5) +
    construct +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_age_placement_age3_std_parameters <- 
  model_parameters(
    a3_age_placement_age3_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_age3_std_parameters

set.seed(123456)
a3_age_placement_age3_parameters_raw <- 
  model_parameters(
    a3_age_placement_age3_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_age3_parameters_raw
```

###### 8 years
```{r}
a3_age_placement_age8_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * I(age_years - 8) +
    construct +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

a3_age_placement_age8_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) * I(age_years - 8) +
    construct +
    male +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_age_placement_age8_std_parameters <- 
  model_parameters(
    a3_age_placement_age8_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_age8_std_parameters

set.seed(123456)
a3_age_placement_age8_parameters_raw <- 
  model_parameters(
    a3_age_placement_age8_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_age8_parameters_raw
```

###### 16 years
```{r}
a3_age_placement_age16_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * I(age_years - 16) +
    construct +
    male +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

a3_age_placement_age16_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) * I(age_years - 16) +
    construct +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_age_placement_age16_std_parameters <- 
  model_parameters(
    a3_age_placement_age16_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_age16_std_parameters

set.seed(123456)
a3_age_placement_age16_parameters_raw <- 
  model_parameters(
    a3_age_placement_age16_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_age_placement_age16_parameters_raw
```

#### Psychopathology

##### Main effect of age of placement

```{r}
contrasts(d_fcg_psy$male) = c(-.5, .5) 

contrasts(d_fcg_psy$domain) = cbind(
  DSEDvADHD = c(-1/5, 1 - (1/5), -1/5, -1/5, -1/5),
  EXTvADHD = c(-1/5, -1/5, 1 - (1/5), -1/5, -1/5),
  INTvADHD = c(-1/5, -1/5, -1/5, 1 - (1/5), -1/5),
  RADvADHD = c(-1/5, -1/5, -1/5, -1/5, 1 - (1/5))
)

contrasts(d_fcg_psy$informant) = c(-.5, .5)
```

```{r}
a3_psy_age_placement_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) +
    male +
    scale(age_years, scale = TRUE) +
    domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

a3_psy_age_placement_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) +
    male +
    scale(age_years, scale = TRUE) +
    domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_parameters_std <-
  model_parameters(
    a3_psy_age_placement_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_age_placement_parameters_std

set.seed(123456)
a3_psy_age_placement_parameters_raw <-
  model_parameters(
    a3_psy_age_placement_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_age_placement_parameters_raw
```

```{r}
# supplementary analyses with extended random effects structure
a3_psy_age_placement_std_rex <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) +
    male +
    scale(age_years, scale = TRUE) +
    domain +
    informant +
    (1|ID) +
    (1|ID:domain) +
    (1|family_id),
  data = d_fcg_psy
)

a3_psy_age_placement_raw_rex <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) +
    male +
    scale(age_years, scale = TRUE) +
    domain +
    informant +
    (1|ID) +
    (1|ID:domain) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_parameters_std_rex <-
  model_parameters(
    a3_psy_age_placement_std_rex,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_age_placement_parameters_std_rex

set.seed(123456)
a3_psy_age_placement_parameters_raw_rex <-
  model_parameters(
    a3_psy_age_placement_raw_rex,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_age_placement_parameters_raw_rex
```

##### Two-way moderations
```{r}
a3_psy_age_placement_int <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * male +
    scale(FC_placement_age, scale = TRUE) * scale(age_years, scale = TRUE) +
    scale(FC_placement_age, scale = TRUE) * domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

anova(a3_psy_age_placement_int)
```

##### Simple effects of age of asssesment

###### 42 months (3.5 years)
```{r}
contrasts(d_fcg_psy$domain) = cbind(
  DSEDvADHD = c(-1/5, 1 - (1/5), -1/5, -1/5, -1/5),
  EXTvADHD = c(-1/5, -1/5, 1 - (1/5), -1/5, -1/5),
  INTvADHD = c(-1/5, -1/5, -1/5, 1 - (1/5), -1/5),
  RADvADHD = c(-1/5, -1/5, -1/5, -1/5, 1 - (1/5))
)

a3_psy_age_placement_age3_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * I(age_years - 3.5) +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_psy
)

a3_psy_age_placement_age3_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) * I(age_years - 3.5) +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_age3_std_parameters <- 
  model_parameters(
    a3_psy_age_placement_age3_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_age3_std_parameters

set.seed(123456)
a3_psy_age_placement_age3_parameters_raw <- 
  model_parameters(
    a3_psy_age_placement_age3_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_age3_parameters_raw
```

###### 8 years
```{r}
a3_psy_age_placement_age8_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * I(age_years - 8) +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_psy
)

a3_psy_age_placement_age8_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) * I(age_years - 8) +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_age8_std_parameters <- 
  model_parameters(
    a3_psy_age_placement_age8_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_age8_std_parameters

set.seed(123456)
a3_psy_age_placement_age8_parameters_raw <- 
  model_parameters(
    a3_psy_age_placement_age8_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_age8_parameters_raw
```

###### 16 years
```{r}
a3_psy_age_placement_age16_std <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * I(age_years - 16) +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

a3_psy_age_placement_age16_raw <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = FALSE) * I(age_years - 16) +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_age16_std_parameters <- 
  model_parameters(
    a3_psy_age_placement_age16_std,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_age16_std_parameters

set.seed(123456)
a3_psy_age_placement_age16_parameters_raw <- 
  model_parameters(
    a3_psy_age_placement_age16_raw,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_age16_parameters_raw
```

### Stability

#### IQ, EEG, physical size

##### Stability 

```{r}
contrasts(d_fcg_cog_bio$male) = c(-.5, .5) 

contrasts(d_fcg_cog_bio$construct) <- cbind(
  "IQvEEG" = c(-1/3, 1 - (1/3), -1/3),
  "PHYSvEEG" = c(-1/3, -1/3, 1 - (1/3))
)

contrasts(d_fcg_cog_bio$stable) = c(0, 1) # disrupted is baseline
```

Stability changes in correspondence with wave/age; therefore, a main effect collapsing across ages of assessment would confound state and trait variance because the parameter estimate represents both a contrast of kids who were ever disrupted vs. not and a contrast of after vs. prior to disruption (i.e., regression estimate would be fit to all disrupted observations vs. all stable observations and some kids are in both groups). To distinguish these sources of variance, only interpret moderated by age so that we can say, at a given age, kids who were disrupted were doing worse/better than kids who were not. 

```{r}
a3_cogbio_stability <- lmer(
  value_z ~ 
    stable * scale(age_years, scale = TRUE) + 
    male +
    construct +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cogbio_stability_parameters <-
  model_parameters(
    a3_cogbio_stability,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_cogbio_stability_parameters
```

```{r}
# supplementary analyses with extended random effects structure
a3_cogbio_stability_rex <- lmer(
  value_z ~ 
    stable * scale(age_years, scale = TRUE) + 
    male +
    construct +
    (1|ID) +
    (1|ID:construct) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cogbio_stability_parameters_rex <-
  model_parameters(
    a3_cogbio_stability_rex,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_cogbio_stability_parameters_rex
```

###### Simple effects of age of asssesment

###### 42 months (3.5 years)
```{r}
contrasts(d_fcg_cog_bio$construct) <- cbind(
  "IQvEEG" = c(-1/3, 1 - (1/3), -1/3),
  "PHYSvEEG" = c(-1/3, -1/3, 1 - (1/3))
)

a3_stab_age3 <- lmer(
  value_z ~ 
    stable * I(age_years - 3.5) +
    construct +
    male +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_stab_age3_parameters <- 
  model_parameters(
    a3_stab_age3,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_stab_age3_parameters

```

###### 8 years
```{r}
a3_stab_age8 <- lmer(
  value_z ~ 
    stable * I(age_years - 8) +
    construct +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_stab_age8_parameters <- 
  model_parameters(
    a3_stab_age8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_stab_age8_parameters
```

###### 16 years
```{r}
a3_stab_age16 <- lmer(
  value_z ~ 
    stable * I(age_years - 16) +
    construct +
    male +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_stab_age16_parameters <- 
  model_parameters(
    a3_stab_age16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_stab_age16_parameters

```

#### Psychopathology

##### Main effect of stability

```{r}
contrasts(d_fcg_psy$male) = c(-.5, .5) 

contrasts(d_fcg_psy$domain) = cbind(
  DSEDvADHD = c(-1/5, 1 - (1/5), -1/5, -1/5, -1/5),
  EXTvADHD = c(-1/5, -1/5, 1 - (1/5), -1/5, -1/5),
  INTvADHD = c(-1/5, -1/5, -1/5, 1 - (1/5), -1/5),
  RADvADHD = c(-1/5, -1/5, -1/5, -1/5, 1 - (1/5))
)

contrasts(d_fcg_psy$informant) = c(-.5, .5)

contrasts(d_fcg_psy$stable) = c(0, 1) # disrupted is baseline
```

```{r}
a3_psy_stability <- lmer(
  value_z ~ 
    stable * scale(age_years, scale = TRUE) +
    male +
    domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stability_parameters <-
  model_parameters(
    a3_psy_stability,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_stability_parameters
```

```{r}
# supplementary analyses with extended random effects structure
a3_psy_stability_rex <- lmer(
  value_z ~ 
    stable * scale(age_years, scale = TRUE) +
    male +
    domain +
    informant +
    (1|ID) +
    (1|ID:domain) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stability_parameters_rex <-
  model_parameters(
    a3_psy_stability_rex,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_stability_parameters_rex
```

###### Simple effects of age of asssesment

###### 42 months (3.5 years)
```{r}
contrasts(d_fcg_psy$domain) = cbind(
  DSEDvADHD = c(-1/5, 1 - (1/5), -1/5, -1/5, -1/5),
  EXTvADHD = c(-1/5, -1/5, 1 - (1/5), -1/5, -1/5),
  INTvADHD = c(-1/5, -1/5, -1/5, 1 - (1/5), -1/5),
  RADvADHD = c(-1/5, -1/5, -1/5, -1/5, 1 - (1/5))
)

a3_psy_stab_age3 <- lmer(
  value_z ~ 
    stable * I(age_years - 3.5) +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stab_age3_parameters <- 
  model_parameters(
    a3_psy_stab_age3,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_stab_age3_parameters

```

###### 8 years
```{r}
a3_psy_stab_age8 <- lmer(
  value_z ~ 
    stable * I(age_years - 8) +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stab_age8_parameters <- 
  model_parameters(
    a3_psy_stab_age8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_stab_age8_parameters
```

###### 16 years
```{r}
a3_psy_stab_age16 <- lmer(
  value_z ~ 
    stable * I(age_years - 16) +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stab_age16_parameters <- 
  model_parameters(
    a3_psy_stab_age16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_stab_age16_parameters

```

# Visualizations of effects

## Aim 1 main effects

### Cognitive and biological
```{r}
d_cog_bio %>% 
  ggplot(aes(group, value_z)) +
  geom_flat_violin(
    aes(color = group, fill = group),
    position = position_nudge(x = .25, y = 0),
    adjust = 2,
    trim = TRUE
  ) +
  geom_point(
    aes(color = group, fill = group),
    position = position_jitter(width = .15),
    size = .25,
    alpha = 1/2
  ) +
  geom_boxplot(
    aes(x = as.numeric(group) + .25, y = value_z, group = group),
    color = "black",
    alpha = 1/3,
    width = .1,
    outlier.shape = NA
  ) +
  scale_y_continuous(breaks = seq.int(-4, 4, 1)) +
  scale_fill_manual(values = cbbPalette) +
  scale_color_manual(values = cbbPalette) +
  theme_beip +
  theme(
    legend.position = "none",
    plot.caption = element_text(hjust = .5, size = 15)
  ) +
  coord_flip() +
  labs(
    x = NULL,
    y = "Standardize score for\ncognitive and biological outcomes"
  )

ggsave(
  paste0(home, "figures/aim1_cog_bio.png"),
  dpi = 600,
  width = 9, 
  height = 7
)
  
```

### Psychopathology
```{r}
d_psy %>% 
  ggplot(aes(group, value_z)) +
  geom_flat_violin(
    aes(color = group, fill = group),
    position = position_nudge(x = .25, y = 0),
    adjust = 2,
    trim = TRUE
  ) +
  geom_point(
    aes(color = group, fill = group),
    position = position_jitter(width = .15),
    size = .25,
    alpha = 1/2
  ) +
  geom_boxplot(
    aes(x = as.numeric(group) + .25, y = value_z, group = group),
    color = "black",
    alpha = 1/3,
    width = .1,
    outlier.shape = NA
  ) +
  scale_y_continuous(breaks = seq.int(-4, 6, 1)) +
  scale_fill_manual(values = cbbPalette) +
  scale_color_manual(values = cbbPalette) +
  theme_beip +
  theme(
    legend.position = "none",
    plot.caption = element_text(hjust = .5, size = 15)
  ) +
  coord_flip() +
  labs(
    x = NULL,
    y = "Standardize score for\n symptoms of psychopathology"
  )

ggsave(
  paste0(home, "figures/aim1_psy.png"),
  dpi = 600,
  width = 9, 
  height = 7
)
  
```

## Aim 2 moderating effects

```{r}
d_plot <-
  d_cog_bio %>% 
  dplyr::select(
    ID, 
    group, 
    male,
    wave_ordered, 
    age_years, 
    construct, 
    value_z
  ) %>% 
  bind_rows(
    d_psy %>% 
      dplyr::select(
        ID, 
        group, 
        male,
        wave_ordered, 
        age_years, 
        domain, 
        value_z
      )
  ) %>% 
  mutate(
    domain_construct_pretty = case_when(
      construct == "IQ" ~ "IQ",
      construct == "physical" ~ "Physical growth",
      construct == "EEG" ~ paste0("EEG alpha power"),
      domain == "rad"~ "Reactive attachment\ndisorder",
      domain == "dsed" ~ "Disinhibited social\nengagement disorder",
      domain == "adhd" ~ "ADHD",
      domain == "extern" ~ "Externalizing",
      domain == "intern" ~ "Internalizing"
    ),
    domain_construct_pretty = fct_relevel(
      domain_construct_pretty,
      "IQ",
      "Physical growth", 
      "EEG alpha power", 
      "Disinhibited social\nengagement disorder",
      "Reactive attachment\ndisorder",
      "ADHD", 
      "Externalizing", 
      "Internalizing"
    ),
    male = if_else(
      male == 1, "Male", "Female"
    ),
    group = recode_factor(
      group,
      "FCG" = "Foster care",
      "CAUG" = "Care as usual"
    )
  )
```

### By domain by age of assessment
```{r}
d_plot %>% 
  ggplot(aes(age_years, value_z, fill = group, color = group)) +
  geom_smooth(method = "lm") +
  scale_y_continuous(breaks = seq.int(-1, 1, .2)) +
  scale_x_continuous(breaks = seq.int(5, 20, 5)) +
  scale_fill_manual(values = cbbPalette) +
  scale_color_manual(values = cbbPalette) +
  theme_beip +
  theme(
    legend.position = "bottom",
    plot.caption = element_text(hjust = .5, size = 16),
    axis.title.y = element_text(vjust = 2)
  ) +
  #coord_flip() +
  labs(
    fill = NULL,
    color = NULL,
    x = "Age of assessment (years)",
    y = "Standardized score"
  ) +
  facet_wrap(.~domain_construct_pretty, ncol = 2)

ggsave(
  paste0(home, "figures/aim2_all_domain_wave.png"),
  dpi = 600,
  width = 6, 
  height = 10
)

ggsave(
  paste0(home, "figures/aim2_all_domain_wave.pdf"),
  dpi = 600,
  width = 6, 
  height = 10
)
```
### Forest plot
```{r}
library(weights)

forest_df_viz <-
  forest_df %>% 
  mutate_at(
    vars(Coefficient:p),
    as.numeric
  ) %>% 
  mutate(
    Parameter = fct_relevel(
      Parameter,
        "Overall cognitive, physical, and neural",
        "Overall psychopathology",
        "IQ",
        "Physical growth",
        "EEG alpha power",
        "Disinhibited social engagement disorder",
        "Reactive attachment disorder",
        "ADHD",
        "Externalizing",
        "Internalizing"
    ),
    p = rd(p, digits = 3),
    p = paste0("p=", p),
    p = if_else(
      p == "p=.0000000", "p<.001", p
    )
  )

forest_df_viz
```

```{r}
forest_cogbio_p <-
  forest_df_viz %>% 
  filter(
    Parameter == "Overall cognitive, physical, and neural" |
    Parameter == "IQ" |
    Parameter == "Physical growth" |
    Parameter == "EEG alpha power"
  ) %>% 
  ggplot(aes(fct_rev(Parameter), Coefficient)) +
  geom_pointrange(
    aes(
      ymin = CI_low,
      ymax = CI_high
    ),
    size = .5
  ) + 
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_text(aes(label = p), nudge_y = .4) +
  scale_y_continuous(breaks = seq.int(-1, 1, .2), limits = c(-1, 1)) +
  coord_flip() +
  theme_beip +
  theme(
    axis.text.y = element_text(face = c("italic", "italic", "italic", "bold"))
  ) +
  labs(
    x = NULL,
    y = "Standardized regression coefficient"
  )

forest_cogbio_p

ggsave(
  paste0(home, "figures/forest_plot_cogbio.png"),
  dpi = 600,
  width = 10.5, 
  height = 5
)

```

```{r}
forest_psy_p <-
  forest_df_viz %>% 
  filter(
    Parameter != "Overall cognitive, physical, and neural",
    Parameter != "IQ",
    Parameter != "Physical growth",
    Parameter != "EEG alpha power",
  ) %>% 
  ggplot(aes(fct_rev(Parameter), Coefficient)) +
  geom_pointrange(
    aes(
      ymin = CI_low,
      ymax = CI_high
    ),
    size = .5
  ) + 
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_text(aes(label = p), nudge_y = .4) +
  scale_y_continuous(breaks = seq.int(-1, 1, .2), limits = c(-1, 1)) +
  coord_flip() +
  theme_beip +
  theme(
    axis.text.y = element_text(face = c("italic", "italic", "italic", "italic", "italic", "bold"))
  ) +
  labs(
    x = NULL,
    y = "Standardized regression coefficient"
  )

forest_psy_p

ggsave(
  paste0(home, "figures/forest_plot_psychopathology.png"),
  dpi = 600,
  width = 9, 
  height = 5
)

ggarrange(
  forest_cogbio_p, 
  forest_psy_p, 
  nrow = 2, 
  align = "hv"
)

ggsave(
  paste0(home, "figures/forest_plot.png"),
  dpi = 600,
  width = 10.5, 
  height = 9
)

ggsave(
  paste0(home, "figures/forest_plot.pdf"),
  dpi = 600,
  width = 10.5, 
  height = 9
)
```

## Aim 3

#### Age of placement by domain
```{r}
d_plot_fcg <-
  d_fcg_cog_bio %>% 
  dplyr::select(
    ID, 
    group, 
    male,
    age_years,
    wave_ordered, 
    FC_placement_age,
    stable,
    construct, 
    value_z
  ) %>% 
  bind_rows(
    d_fcg_psy %>% 
      dplyr::select(
        ID, 
        group, 
        male,
        age_years,
        wave_ordered, 
        FC_placement_age,
        stable,
        domain, 
        value_z
      )
  ) %>% 
  mutate(
    domain_construct_pretty = case_when(
      construct == "IQ" ~ "IQ",
      construct == "physical" ~ "Physical growth",
      construct == "EEG" ~ "EEG alpha power",
      domain == "rad"~ "Reactive attachment\ndisorder",
      domain == "dsed" ~ "Disinhibited social\nengagement disorder",
      domain == "adhd" ~ "ADHD",
      domain == "extern" ~ "Externalizing",
      domain == "intern" ~ "Internalizing"
    ),
    domain_construct_pretty = fct_relevel(
      domain_construct_pretty,
      "IQ",
      "Physical growth", 
      "EEG alpha power", 
      "Disinhibited social\nengagement disorder",
      "Reactive attachment\ndisorder",
      "ADHD", 
      "Externalizing", 
      "Internalizing"
    ),
    stable = recode_factor(
      stable,
      "disrupted" = "Disrupted",
      "stable" = "Stable"
    )
  )

d_plot_fcg %>% 
  ggplot(
    aes(
      FC_placement_age, 
      value_z, 
      color = wave_ordered
    )
  ) +
  geom_smooth(method = "lm", size = 2, se = FALSE) +
  scale_y_continuous(breaks = seq.int(-1, 1.4, .4)) +
  scale_x_continuous(breaks = seq.int(0, 30, 5)) +
  scale_color_viridis_d() +
  theme_beip +
  theme(
    legend.position = "right",
    plot.caption = element_text(hjust = .5, size = 16),
    axis.title.y = element_text(vjust = 2)
  ) +
  labs(
    color = "Assessment wave",
    x = "Age of placement in foster care (months)",
    y = "Standardized score"
  ) +
  facet_wrap(.~domain_construct_pretty, ncol = 2)

ggsave(
  paste0(home, "figures/aim3_all_ageplacement_domain_wave.png"),
  dpi = 600,
  width = 9, 
  height = 11
)

```


#### Stability by age of assessment 
```{r}
d_plot_fcg %>% 
  filter(!is.na(stable)) %>% 
  ggplot(
    aes(
      age_years, 
      value_z, 
      color = stable,
      fill = stable
    )
  ) +
  geom_smooth(method = "lm", size = 2) +
  scale_y_continuous(breaks = seq.int(-1, 1.4, .4)) +
  scale_x_continuous(breaks = seq.int(0, 30, 5)) +
  scale_color_viridis_d(begin = .5) +
  scale_fill_viridis_d(guide = FALSE, begin = .5) +
  theme_beip +
  theme(
    legend.position = "bottom",
    plot.caption = element_text(hjust = .5, size = 16),
    axis.title.y = element_text(vjust = 2)
  ) +
  labs(
    color = NULL,
    x = "Age of assessment (years)",
    y = "Standardized score"
  ) +
  facet_wrap(.~domain_construct_pretty, ncol = 2)

ggsave(
  paste0(home, "figures/aim3_all_stability_domain_age.png"),
  dpi = 600,
  width = 6, 
  height = 10
)

ggsave(
  paste0(home, "figures/aim3_all_stability_domain_age.pdf"),
  dpi = 600,
  width = 6, 
  height = 10
)
```

# Supplemental Analyses

## Associations of baseline characteristics with stability at each wave
```{r}
stability_wide <- 
  d %>% 
  filter(group == "FCG") %>% 
  select(
    ID,
    wave,
    stable_num,
    stability_group
  ) %>% 
  distinct(ID, wave, stable_num, .keep_all = TRUE) %>% 
  filter(!is.na(stable_num)) %>% 
  # because child could be disrupted between assessment WITHIN a wave, counting as disrupted if marked as "0" for at least one assessment in that wave
  group_by(ID, wave) %>% 
  mutate(
    stable_num = max(stable_num, na.rm = TRUE)
  ) %>%
  distinct(ID, wave, stable_num, .keep_all = TRUE) %>% 
  pivot_wider(
    names_from = wave,
    values_from = stable_num,
    names_prefix = "stable_"
  ) 
```

```{r}
d_BL_wide_FCG <-
  d_BL_wide %>% 
  filter(group == "FCG") %>% 
  left_join(stability_wide, by = "ID") 
```

```{r}
## 8-year wave stability ~ baseline characteristics
d_BL_wide_FCG %>% 
  count(stable_8y)

# DSED
t.test(d_BL_wide_FCG$dsed ~ d_BL_wide_FCG$stable_8y)

# RAD
t.test(d_BL_wide_FCG$rad ~ d_BL_wide_FCG$stable_8y)

# ADHD
t.test(d_BL_wide_FCG$adhd ~ d_BL_wide_FCG$stable_8y)

# externalizing
t.test(d_BL_wide_FCG$extern ~ d_BL_wide_FCG$stable_8y)

# internalizing
t.test(d_BL_wide_FCG$intern ~ d_BL_wide_FCG$stable_8y)

# head circumference
t.test(d_BL_wide_FCG$head ~ d_BL_wide_FCG$stable_8y)

# height
t.test(d_BL_wide_FCG$height ~ d_BL_wide_FCG$stable_8y)

# weight
t.test(d_BL_wide_FCG$weight ~ d_BL_wide_FCG$stable_8y)

# weight
t.test(d_BL_wide_FCG$iq ~ d_BL_wide_FCG$stable_8y)
```

```{r}
## 12-year wave stability ~ baseline characteristics
d_BL_wide_FCG %>% 
  count(stable_12y)

# DSED
t.test(d_BL_wide_FCG$dsed ~ d_BL_wide_FCG$stable_12y)

# RAD
t.test(d_BL_wide_FCG$rad ~ d_BL_wide_FCG$stable_12y)

# ADHD
t.test(d_BL_wide_FCG$adhd ~ d_BL_wide_FCG$stable_12y)

# externalizing
t.test(d_BL_wide_FCG$extern ~ d_BL_wide_FCG$stable_12y)

# internalizing
t.test(d_BL_wide_FCG$intern ~ d_BL_wide_FCG$stable_12y)

# head circumference
t.test(d_BL_wide_FCG$head ~ d_BL_wide_FCG$stable_12y)

# height
t.test(d_BL_wide_FCG$height ~ d_BL_wide_FCG$stable_12y)

# weight
t.test(d_BL_wide_FCG$weight ~ d_BL_wide_FCG$stable_12y)

# weight
t.test(d_BL_wide_FCG$iq ~ d_BL_wide_FCG$stable_12y)
```

```{r}
## 16/18-year wave stability ~ baseline characteristics
d_BL_wide_FCG %>% 
  count(`stable_16-18y`)

# DSED
t.test(d_BL_wide_FCG$dsed ~ d_BL_wide_FCG$`stable_16-18y`)

# RAD
t.test(d_BL_wide_FCG$rad ~ d_BL_wide_FCG$`stable_16-18y`)

# ADHD
t.test(d_BL_wide_FCG$adhd ~ d_BL_wide_FCG$`stable_16-18y`)

# externalizing
t.test(d_BL_wide_FCG$extern ~ d_BL_wide_FCG$`stable_16-18y`)

# internalizing
t.test(d_BL_wide_FCG$intern ~ d_BL_wide_FCG$`stable_16-18y`)

# head circumference
t.test(d_BL_wide_FCG$head ~ d_BL_wide_FCG$`stable_16-18y`)

# height
t.test(d_BL_wide_FCG$height ~ d_BL_wide_FCG$`stable_16-18y`)

# weight
t.test(d_BL_wide_FCG$weight ~ d_BL_wide_FCG$`stable_16-18y`)

# weight
t.test(d_BL_wide_FCG$iq ~ d_BL_wide_FCG$`stable_16-18y`)
```
## Aim 2: Age as categorical

### EEG, IQ, physical size

```{r}
# CAUG is baseline
contrasts(d_cog_bio$group) = c(0, 1)

contrasts(d_cog_bio$male) = c(-.5, .5) 

contrasts(d_cog_bio$construct) <- cbind(
  IQvEEG = c(-1/3, 1 - (1/3), -1/3),
  PHYSvEEG = c(-1/3, -1/3, 1 - (1/3))
)

contrasts(d_cog_bio$wave_ordered) <- cbind(
  `42mv30m` = c(-1/6, 1 - (1/6), -1/6, -1/6, -1/6, -1/6),
  `54mv30m` = c(-1/6, -1/6, 1 - (1/6), -1/6, -1/6, -1/6),
  `8yv30m` = c(-1/6, -1/6, -1/6, 1 - (1/6), -1/6, -1/6),
  `12yv30m` = c(-1/6, -1/6, -1/6, -1/6, 1 - (1/6), -1/6),
  `16yv30m` = c(-1/6, -1/6, -1/6, -1/6, -1/6, 1 - (1/6))
)
```

#### Two-way moderations
```{r}
a2_cogbio_sup <- lmer(
  value_z ~ 
    group * construct +
    group * male +
    group * wave_ordered +
    (1|ID) +
    (1|family_id), 
  REML = FALSE,
  data = d_cog_bio
)

anova(a2_cogbio_sup)
```

### Psychopathology

```{r}
contrasts(d_psy$group) = c(0, 1) # CAUG is baseline

contrasts(d_psy$male) = c(-.5, .5) 

contrasts(d_psy$domain) = cbind(
  DSEDvADHD = c(-1/5, 1 - (1/5), -1/5, -1/5, -1/5),
  EXTvADHD = c(-1/5, -1/5, 1 - (1/5), -1/5, -1/5),
  INTvADHD = c(-1/5, -1/5, -1/5, 1 - (1/5), -1/5),
  RADvADHD = c(-1/5, -1/5, -1/5, -1/5, 1 - (1/5))
)

contrasts(d_psy$informant) = c(-.5, .5)

contrasts(d_psy$wave_ordered) <- cbind(
  `42mv30m` = c(-1/6, 1 - (1/6), -1/6, -1/6, -1/6, -1/6),
  `54mv30m` = c(-1/6, -1/6, 1 - (1/6), -1/6, -1/6, -1/6),
  `8yv30m` = c(-1/6, -1/6, -1/6, 1 - (1/6), -1/6, -1/6),
  `12yv30m` = c(-1/6, -1/6, -1/6, -1/6, 1 - (1/6), -1/6),
  `16yv30m` = c(-1/6, -1/6, -1/6, -1/6, -1/6, 1 - (1/6))
)
```

#### Two-way moderations
```{r}
a2_psy_type_sup <- lmer(
  value_z ~ 
    group * domain +
    group * male +
    group * wave_ordered +
    informant +
    (1|ID) +
    (1|family_id),  
  data = d_psy
)

anova(a2_psy_type_sup)
```

### Visualize effect of the intervention by assessment wave
```{r}
d_plot_summary <-
  d_plot %>% 
  group_by(group, wave_ordered, domain_construct_pretty) %>% 
  summarise(
    n = n(),
    mean = mean(value_z),
    sd = sd(value_z),
    se = sd / sqrt(n)
  )

d_plot_summary %>% 
  ggplot(aes(wave_ordered, mean, color = group)) +
  geom_pointrange(
    aes(
      ymin = mean - se,
      ymax = mean + se
    ),
    position = "dodge"
  ) +
  #scale_fill_manual(values = cbbPalette) +
  scale_color_manual(values = cbbPalette) +
  theme_beip +
  theme(
    legend.position = "bottom",
    plot.caption = element_text(hjust = .5, size = 16),
    axis.title.y = element_text(vjust = 2),
    axis.title.x = element_text(vjust = -1),
    panel.grid.major.x = element_line(color = "gray", linetype = 3)
  ) +
  #coord_flip() +
  labs(
    fill = NULL,
    color = NULL,
    x = "Assessment wave",
    y = "Standardized score"
  ) +
  facet_wrap(.~domain_construct_pretty, ncol = 2)

ggsave(
  paste0(home, "figures/supplemental_aim2_domain_wave_means.png"),
  dpi = 600,
  width = 9, 
  height = 11
)
```


## Aim 3: Age as categorical

### Age of placement

#### EEG, IQ, physical size 
```{r}
contrasts(d_fcg_cog_bio$male) = c(-.5, .5) 

contrasts(d_fcg_cog_bio$construct) <- cbind(
  IQvEEG = c(-1/3, 1 - (1/3), -1/3),
  PHYSvEEG = c(-1/3, -1/3, 1 - (1/3))
)

contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `42mv30m` = c(-1/6, 1 - (1/6), -1/6, -1/6, -1/6, -1/6),
  `54mv30m` = c(-1/6, -1/6, 1 - (1/6), -1/6, -1/6, -1/6),
  `8yv30m` = c(-1/6, -1/6, -1/6, 1 - (1/6), -1/6, -1/6),
  `12yv30m` = c(-1/6, -1/6, -1/6, -1/6, 1 - (1/6), -1/6),
  `16yv30m` = c(-1/6, -1/6, -1/6, -1/6, -1/6, 1 - (1/6))
)
```

```{r}
###### Two-way moderations
a3_age_placement_sup_X <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * male +
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    scale(FC_placement_age, scale = TRUE) * construct +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

anova(a3_age_placement_std_X)
```

##### By wave
```{r}
# 30 months is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `42mv30m` = c(0, 1, 0, 0, 0, 0),
  `54mv30m` = c(0, 0, 1, 0, 0, 0),
  `8yv30m` = c(0, 0, 0, 1, 0, 0),
  `12yv30m` = c(0, 0, 0, 0, 1, 0),
  `16yv30m` = c(0, 0, 0, 0, 0, 1)
)

a3_cog_bio_age_placement_wave30 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    construct +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cog_bio_age_placement_wave30_parameters <- 
  model_parameters(
    a3_cog_bio_age_placement_wave30,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_cog_bio_age_placement_wave30_parameters

```
```{r}
# 42 months is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `30mv42m` = c(1, 0, 0, 0, 0, 0),
  `54mv42m` = c(0, 0, 1, 0, 0, 0),
  `8yv42m` = c(0, 0, 0, 1, 0, 0),
  `12yv42m` = c(0, 0, 0, 0, 1, 0),
  `16yv42m` = c(0, 0, 0, 0, 0, 1)
)

a3_cog_bio_age_placement_wave42 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    construct +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cog_bio_age_placement_wave42_parameters <- 
  model_parameters(
    a3_cog_bio_age_placement_wave42,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_cog_bio_age_placement_wave42_parameters

```

```{r}
# 54 months is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `30mv54m` = c(1, 0, 0, 0, 0, 0),
  `42mv54m` = c(0, 1, 0, 0, 0, 0),
  `8yv54m` = c(0, 0, 0, 1, 0, 0),
  `12yv54m` = c(0, 0, 0, 0, 1, 0),
  `16yv54m` = c(0, 0, 0, 0, 0, 1)
)

a3_cog_bio_age_placement_wave54 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    construct +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cog_bio_age_placement_wave54_parameters <- 
  model_parameters(
    a3_cog_bio_age_placement_wave54,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_cog_bio_age_placement_wave54_parameters

```


```{r}
# 8 years is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `30mv8y` = c(1, 0, 0, 0, 0, 0),
  `42mv8y` = c(0, 1, 0, 0, 0, 0),
  `54mv8y` = c(0, 0, 1, 0, 0, 0),
  `12yv8y` = c(0, 0, 0, 0, 1, 0),
  `16yv8y` = c(0, 0, 0, 0, 0, 1)
)

a3_cog_bio_age_placement_wave8 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    construct +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cog_bio_age_placement_wave8_parameters <- 
  model_parameters(
    a3_cog_bio_age_placement_wave8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_cog_bio_age_placement_wave8_parameters

```

```{r}
# 12 years is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `30mv12y` = c(1, 0, 0, 0, 0, 0),
  `42mv12y` = c(0, 1, 0, 0, 0, 0),
  `54mv12y` = c(0, 0, 1, 0, 0, 0),
  `8yv12y` = c(0, 0, 0, 1, 0, 0),
  `16yv12y` = c(0, 0, 0, 0, 0, 1)
)

a3_cog_bio_age_placement_wave12 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    construct +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cog_bio_age_placement_wave12_parameters <- 
  model_parameters(
    a3_cog_bio_age_placement_wave12,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_cog_bio_age_placement_wave12_parameters

```

```{r}
# 16 years is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `30mv16y` = c(1, 0, 0, 0, 0, 0),
  `42mv16y` = c(0, 1, 0, 0, 0, 0),
  `54mv16y` = c(0, 0, 1, 0, 0, 0),
  `8yv16y` = c(0, 0, 0, 1, 0, 0),
  `12yv16y` = c(0, 0, 0, 0, 1, 0)
)

a3_cog_bio_age_placement_wave16 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    construct +
    male +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cog_bio_age_placement_wave16_parameters <- 
  model_parameters(
    a3_cog_bio_age_placement_wave16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_cog_bio_age_placement_wave16_parameters

```

#### Psychopathology 
```{r}
contrasts(d_fcg_psy$male) = c(-.5, .5) 

contrasts(d_fcg_psy$domain) = cbind(
  DSEDvADHD = c(-1/5, 1 - (1/5), -1/5, -1/5, -1/5),
  EXTvADHD = c(-1/5, -1/5, 1 - (1/5), -1/5, -1/5),
  INTvADHD = c(-1/5, -1/5, -1/5, 1 - (1/5), -1/5),
  RADvADHD = c(-1/5, -1/5, -1/5, -1/5, 1 - (1/5))
)

contrasts(d_fcg_psy$informant) = c(-.5, .5)

contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `42mv30m` = c(-1/6, 1 - (1/6), -1/6, -1/6, -1/6, -1/6),
  `54mv30m` = c(-1/6, -1/6, 1 - (1/6), -1/6, -1/6, -1/6),
  `8yv30m` = c(-1/6, -1/6, -1/6, 1 - (1/6), -1/6, -1/6),
  `12yv30m` = c(-1/6, -1/6, -1/6, -1/6, 1 - (1/6), -1/6),
  `16yv30m` = c(-1/6, -1/6, -1/6, -1/6, -1/6, 1 - (1/6))
)
```


```{r}
a3_psy_age_placement_sup_X <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * male +
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    scale(FC_placement_age, scale = TRUE) * domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

anova(a3_psy_age_placement_sup_X)
```

##### By wave
```{r}
# 30 months is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `42mv30m` = c(0, 1, 0, 0, 0, 0),
  `54mv30m` = c(0, 0, 1, 0, 0, 0),
  `8yv30m` = c(0, 0, 0, 1, 0, 0),
  `12yv30m` = c(0, 0, 0, 0, 1, 0),
  `16yv30m` = c(0, 0, 0, 0, 0, 1)
)

a3_psy_age_placement_wave30 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_wave30_parameters <- 
  model_parameters(
    a3_psy_age_placement_wave30,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_wave30_parameters
```

```{r}
# 42 months is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `30mv42m` = c(1, 0, 0, 0, 0, 0),
  `54mv42m` = c(0, 0, 1, 0, 0, 0),
  `8yv42m` = c(0, 0, 0, 1, 0, 0),
  `12yv42m` = c(0, 0, 0, 0, 1, 0),
  `16yv42m` = c(0, 0, 0, 0, 0, 1)
)

a3_psy_age_placement_wave42 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_wave42_parameters <- 
  model_parameters(
    a3_psy_age_placement_wave42,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_wave42_parameters
```
```{r}
# 54 months is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `30mv54m` = c(1, 0, 0, 0, 0, 0),
  `42mv54m` = c(0, 1, 0, 0, 0, 0),
  `8yv54m` = c(0, 0, 0, 1, 0, 0),
  `12yv54m` = c(0, 0, 0, 0, 1, 0),
  `16yv54m` = c(0, 0, 0, 0, 0, 1)
)

a3_psy_age_placement_wave54 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_wave54_parameters <- 
  model_parameters(
    a3_psy_age_placement_wave54,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_wave54_parameters
```

```{r}
# 8 years is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `30mv8y` = c(1, 0, 0, 0, 0, 0),
  `42mv8y` = c(0, 1, 0, 0, 0, 0),
  `54mv8y` = c(0, 0, 1, 0, 0, 0),
  `12yv8y` = c(0, 0, 0, 0, 1, 0),
  `16yv8y` = c(0, 0, 0, 0, 0, 1)
)

a3_psy_age_placement_wave8 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_wave8_parameters <- 
  model_parameters(
    a3_psy_age_placement_wave8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_wave8_parameters
```

```{r}
# 12 years is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `30mv12y` = c(1, 0, 0, 0, 0, 0),
  `42mv12y` = c(0, 1, 0, 0, 0, 0),
  `54mv12y` = c(0, 0, 1, 0, 0, 0),
  `8yv12y` = c(0, 0, 0, 1, 0, 0),
  `16yv8y` = c(0, 0, 0, 0, 0, 1)
)

a3_psy_age_placement_wave12 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_wave12_parameters <- 
  model_parameters(
    a3_psy_age_placement_wave12,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_wave12_parameters
```

```{r}
# 16-18 years is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `30mv12y` = c(1, 0, 0, 0, 0, 0),
  `42mv12y` = c(0, 1, 0, 0, 0, 0),
  `54mv12y` = c(0, 0, 1, 0, 0, 0),
  `8yv12y` = c(0, 0, 0, 1, 0, 0),
  `16yv8y` = c(0, 0, 0, 0, 1, 0)
)

a3_psy_age_placement_wave16 <- lmer(
  value_z ~ 
    scale(FC_placement_age, scale = TRUE) * wave_ordered +
    domain +
    male +
    informant +
    (1|ID) +
    (1|family_id), 
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_age_placement_wave16_parameters <- 
  model_parameters(
    a3_psy_age_placement_wave16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )
a3_psy_age_placement_wave16_parameters
```

### Stability

#### EEG, IQ, physical size

```{r}
contrasts(d_fcg_cog_bio$stable) = c(0, 1) # disrupted is baseline

contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `42mv30m` = c(-1/6, 1 - (1/6), -1/6, -1/6, -1/6, -1/6),
  `54mv30m` = c(-1/6, -1/6, 1 - (1/6), -1/6, -1/6, -1/6),
  `8yv30m` = c(-1/6, -1/6, -1/6, 1 - (1/6), -1/6, -1/6),
  `12yv30m` = c(-1/6, -1/6, -1/6, -1/6, 1 - (1/6), -1/6),
  `16yv30m` = c(-1/6, -1/6, -1/6, -1/6, -1/6, 1 - (1/6))
)
```

```{r}
a3_cogbio_stability_wave_X <- lmer(
  value_z ~ 
    stable * wave_ordered + 
    male +
    construct +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

anova(a3_cogbio_stability_wave_X)

```

##### By wave
```{r}
# 30 months is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `42mv30m` = c(0, 1, 0, 0, 0, 0),
  `54mv30m` = c(0, 0, 1, 0, 0, 0),
  `8yv30m` = c(0, 0, 0, 1, 0, 0),
  `12yv30m` = c(0, 0, 0, 0, 1, 0),
  `16yv30m` = c(0, 0, 0, 0, 0, 1)
)

a3_cogbio_stability_wave30 <- lmer(
  value_z ~ 
    stable * wave_ordered + 
    male +
    construct +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cogbio_stability_wave30_parameters <-
  model_parameters(
    a3_cogbio_stability_wave30,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_cogbio_stability_wave30_parameters
```
```{r}
# 42 months is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `30mv42m` = c(1, 0, 0, 0, 0, 0),
  `54mv42m` = c(0, 0, 1, 0, 0, 0),
  `8yv42m` = c(0, 0, 0, 1, 0, 0),
  `12yv42m` = c(0, 0, 0, 0, 1, 0),
  `16yv42m` = c(0, 0, 0, 0, 0, 1)
)

a3_cogbio_stability_wave42 <- lmer(
  value_z ~ 
    stable * wave_ordered + 
    male +
    construct +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cogbio_stability_wave42_parameters <-
  model_parameters(
    a3_cogbio_stability_wave42,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_cogbio_stability_wave42_parameters
```
```{r}
# 54 months is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `30mv54m` = c(1, 0, 0, 0, 0, 0),
  `42mv54m` = c(0, 1, 0, 0, 0, 0),
  `8yv54m` = c(0, 0, 0, 1, 0, 0),
  `12yv54m` = c(0, 0, 0, 0, 1, 0),
  `16yv54m` = c(0, 0, 0, 0, 0, 1)
)

a3_cogbio_stability_wave54 <- lmer(
  value_z ~ 
    stable * wave_ordered + 
    male +
    construct +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cogbio_stability_wave54_parameters <-
  model_parameters(
    a3_cogbio_stability_wave54,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_cogbio_stability_wave54_parameters
```

```{r}
# 8 years is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `30mv8y` = c(1, 0, 0, 0, 0, 0),
  `42mv8y` = c(0, 1, 0, 0, 0, 0),
  `54mv8y` = c(0, 0, 1, 0, 0, 0),
  `12yv8y` = c(0, 0, 0, 0, 1, 0),
  `16yv8y` = c(0, 0, 0, 0, 0, 1)
)

a3_cogbio_stability_wave8 <- lmer(
  value_z ~ 
    stable * wave_ordered + 
    male +
    construct +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cogbio_stability_wave8_parameters <-
  model_parameters(
    a3_cogbio_stability_wave8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_cogbio_stability_wave8_parameters
```

```{r}
# 12 years is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `30mv12y` = c(1, 0, 0, 0, 0, 0),
  `42mv12y` = c(0, 1, 0, 0, 0, 0),
  `54mv12y` = c(0, 0, 1, 0, 0, 0),
  `8yv12y` = c(0, 0, 0, 1, 0, 0),
  `16yv12y` = c(0, 0, 0, 0, 0, 1)
)

a3_cogbio_stability_wave12 <- lmer(
  value_z ~ 
    stable * wave_ordered + 
    male +
    construct +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cogbio_stability_wave12_parameters <-
  model_parameters(
    a3_cogbio_stability_wave12,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_cogbio_stability_wave12_parameters
```

```{r}
# 16 years is baseline
contrasts(d_fcg_cog_bio$wave_ordered) <- cbind(
  `30mv16y` = c(1, 0, 0, 0, 0, 0),
  `42mv16y` = c(0, 1, 0, 0, 0, 0),
  `54mv16y` = c(0, 0, 1, 0, 0, 0),
  `8yv16y` = c(0, 0, 0, 1, 0, 0),
  `12yv16y` = c(0, 0, 0, 0, 1, 0)
)

a3_cogbio_stability_wave16 <- lmer(
  value_z ~ 
    stable * wave_ordered + 
    male +
    construct +
    (1|ID) +
    (1|family_id),
  data = d_fcg_cog_bio
)

set.seed(123456)
a3_cogbio_stability_wave16_parameters <-
  model_parameters(
    a3_cogbio_stability_wave16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_cogbio_stability_wave16_parameters
```

### Psychopathology
```{r}
contrasts(d_fcg_psy$stable) = c(0, 1) # disrupted is baseline

contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `42mv30m` = c(-1/6, 1 - (1/6), -1/6, -1/6, -1/6, -1/6),
  `54mv30m` = c(-1/6, -1/6, 1 - (1/6), -1/6, -1/6, -1/6),
  `8yv30m` = c(-1/6, -1/6, -1/6, 1 - (1/6), -1/6, -1/6),
  `12yv30m` = c(-1/6, -1/6, -1/6, -1/6, 1 - (1/6), -1/6),
  `16yv30m` = c(-1/6, -1/6, -1/6, -1/6, -1/6, 1 - (1/6))
)
```

```{r}
a3_psy_stability_wave <- lmer(
  value_z ~ 
    stable * wave_ordered +
    male +
    domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

anova(a3_psy_stability_wave)
```


#### By wave

```{r}
# 30 months is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `42mv30m` = c(0, 1, 0, 0, 0, 0),
  `54mv30m` = c(0, 0, 1, 0, 0, 0),
  `8yv30m` = c(0, 0, 0, 1, 0, 0),
  `12yv30m` = c(0, 0, 0, 0, 1, 0),
  `16yv30m` = c(0, 0, 0, 0, 0, 1)
)

a3_psy_stability_wave30 <- lmer(
  value_z ~ 
    stable * wave_ordered +
    male +
    domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stability_wave30_parameters <-
  model_parameters(
    a3_psy_stability_wave30,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_stability_wave30_parameters
```

```{r}
# 42 months is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `30mv42m` = c(1, 0, 0, 0, 0, 0),
  `54mv42m` = c(0, 0, 1, 0, 0, 0),
  `8yv42m` = c(0, 0, 0, 1, 0, 0),
  `12yv42m` = c(0, 0, 0, 0, 1, 0),
  `16yv42m` = c(0, 0, 0, 0, 0, 1)
)

a3_psy_stability_wave42 <- lmer(
  value_z ~ 
    stable * wave_ordered +
    male +
    domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stability_wave42_parameters <-
  model_parameters(
    a3_psy_stability_wave42,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_stability_wave42_parameters
```

```{r}
# 54 months is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `30mv54m` = c(1, 0, 0, 0, 0, 0),
  `42mv54m` = c(0, 1, 0, 0, 0, 0),
  `8yv54m` = c(0, 0, 0, 1, 0, 0),
  `12yv54m` = c(0, 0, 0, 0, 1, 0),
  `16yv54m` = c(0, 0, 0, 0, 0, 1)
)

a3_psy_stability_wave54 <- lmer(
  value_z ~ 
    stable * wave_ordered +
    male +
    domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stability_wave54_parameters <-
  model_parameters(
    a3_psy_stability_wave54,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_stability_wave54_parameters
```

```{r}
# 8 years is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `30mv8y` = c(1, 0, 0, 0, 0, 0),
  `42mv8y` = c(0, 1, 0, 0, 0, 0),
  `54mv8y` = c(0, 0, 1, 0, 0, 0),
  `12yv8y` = c(0, 0, 0, 0, 1, 0),
  `16yv8y` = c(0, 0, 0, 0, 0, 1)
)

a3_psy_stability_wave8 <- lmer(
  value_z ~ 
    stable * wave_ordered +
    male +
    domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stability_wave8_parameters <-
  model_parameters(
    a3_psy_stability_wave8,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_stability_wave8_parameters
```

```{r}
# 12 years is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `30mv12y` = c(1, 0, 0, 0, 0, 0),
  `42mv12y` = c(0, 1, 0, 0, 0, 0),
  `54mv12y` = c(0, 0, 1, 0, 0, 0),
  `8yv12y` = c(0, 0, 0, 1, 0, 0),
  `16yv8y` = c(0, 0, 0, 0, 0, 1)
)

a3_psy_stability_wave12 <- lmer(
  value_z ~ 
    stable * wave_ordered +
    male +
    domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stability_wave12_parameters <-
  model_parameters(
    a3_psy_stability_wave12,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_stability_wave12_parameters
```

```{r}
# 16-18 years is baseline
contrasts(d_fcg_psy$wave_ordered) <- cbind(
  `30mv12y` = c(1, 0, 0, 0, 0, 0),
  `42mv12y` = c(0, 1, 0, 0, 0, 0),
  `54mv12y` = c(0, 0, 1, 0, 0, 0),
  `8yv12y` = c(0, 0, 0, 1, 0, 0),
  `16yv8y` = c(0, 0, 0, 0, 1, 0)
)


a3_psy_stability_wave16 <- lmer(
  value_z ~ 
    stable * wave_ordered +
    male +
    domain +
    informant +
    (1|ID) +
    (1|family_id),
  data = d_fcg_psy
)

set.seed(123456)
a3_psy_stability_wave16_parameters <-
  model_parameters(
    a3_psy_stability_wave16,
    bootstrap = TRUE,
    ci_method = "quantile",
    iterations = 1000
  )

a3_psy_stability_wave16_parameters
```

## Visualize effect of placement stability by assessment wave
```{r}
d_plot_fcg_stable_summary <-
  d_plot_fcg %>% 
  filter(!is.na(stable)) %>% 
  group_by(stable, wave_ordered, domain_construct_pretty) %>% 
  summarise(
    n = n(),
    mean = mean(value_z),
    sd = sd(value_z),
    se = sd / sqrt(n)
  )

d_plot_fcg_stable_summary %>% 
  ggplot(aes(wave_ordered, mean, color = stable)) +
  geom_pointrange(
    aes(
      ymin = mean - se,
      ymax = mean + se
    ),
    #position = position_dodge(width = .5),
    size = .65
  ) +
  scale_color_viridis_d(begin = .5) +
  scale_fill_viridis_d(guide = FALSE, begin = .5) +
  theme_beip +
  theme(
    legend.position = "bottom",
    plot.caption = element_text(hjust = .5, size = 16),
    axis.title.y = element_text(vjust = 2),
    axis.title.x = element_text(vjust = -.5),
    panel.grid.major.x = element_line(color = "gray", linetype = 3)
  ) +
  labs(
    color = NULL,
    x = "Age of assessment (years)",
    y = "Standardized score"
  ) +
  facet_wrap(.~domain_construct_pretty, ncol = 2)

ggsave(
  paste0(home, "figures/supplemental_aim3_stability_domain_wave_means.png"),
  dpi = 600,
  width = 9, 
  height = 11
)
```